<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;xilihuasi.github.io&quot;,&quot;root&quot;:&quot;&#x2F;blog&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;blog&#x2F;images&quot;,&quot;scheme&quot;:&quot;Pisces&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}</script>
<meta property="og:type" content="website">
<meta property="og:title" content="xilihuasi&#39;s blog">
<meta property="og:url" content="https://xilihuasi.github.io/blog/index.html">
<meta property="og:site_name" content="xilihuasi&#39;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="xilihuasi">
<meta property="article:tag" content="xilihuasi blog dev react">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://xilihuasi.github.io/blog/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:true,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:&quot;&quot;,&quot;permalink&quot;:&quot;&quot;,&quot;path&quot;:&quot;index.html&quot;,&quot;title&quot;:&quot;&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>xilihuasi's blog</title><script src="/blog/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">xilihuasi's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">forerver old, forerver can't cry</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">xilihuasi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2021/06/01/2021/hello-everyone/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/06/01/2021/hello-everyone/" class="post-title-link" itemprop="url">Hello Everyone</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-01 15:09:23" itemprop="dateCreated datePublished" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>开始给 hexo 除草了，最近在重新整理之前其他平台发布的文章，以后统一在这里管理。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2019/07/11/2019/%E3%80%90%E8%AF%91%E3%80%91%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%9A%E6%9C%AA%E6%9D%A5%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E7%9A%84%E6%96%B0%E8%B6%8B%E5%8A%BF%E2%80%94%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/07/11/2019/%E3%80%90%E8%AF%91%E3%80%91%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%9A%E6%9C%AA%E6%9D%A5%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E7%9A%84%E6%96%B0%E8%B6%8B%E5%8A%BF%E2%80%94%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/" class="post-title-link" itemprop="url">【译】微前端：未来前端开发的新趋势—第三部分</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-07-11 23:41:34" itemprop="dateCreated datePublished" datetime="2019-07-11T23:41:34+00:00">2019-07-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 15:09:23" itemprop="dateModified" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%8E%98%E9%87%91%E7%BF%BB%E8%AF%91%E8%AE%A1%E5%88%92/" itemprop="url" rel="index"><span itemprop="name">掘金翻译计划</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<ul>
<li>原文地址：<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/micro-frontends.html">Micro Frontends</a></li>
<li>原文作者：<a target="_blank" rel="noopener" href="https://camjackson.net/">Cam Jackson</a></li>
<li>译文出自：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a></li>
<li>本文永久链接：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-3.md">https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-3.md</a></li>
<li>译者：<a target="_blank" rel="noopener" href="https://github.com/xilihuasi">xilihuasi</a></li>
<li>校对者：<a target="_blank" rel="noopener" href="https://github.com/Stevens1995">Stevens1995</a>, <a target="_blank" rel="noopener" href="https://github.com/lgh757079506">lgh757079506</a></li>
</ul>
</blockquote>
<h1 id="微前端：未来前端开发的新趋势-—-第三部分"><a href="#微前端：未来前端开发的新趋势-—-第三部分" class="headerlink" title="微前端：未来前端开发的新趋势 — 第三部分"></a>微前端：未来前端开发的新趋势 — 第三部分</h1><p>做好前端开发不是件容易的事情，而比这更难的是扩展前端开发规模以便于多个团队可以同时开发一个大型且复杂的产品。本系列文章将描述一种趋势，可以将大型的前端项目分解成许多个小而易于管理的部分，也将讨论这种体系结构如何提高前端代码团队工作的有效性和效率。除了讨论各种好处和代价之外，我们还将介绍一些可用的实现方案和深入探讨一个应用该技术的完整示例应用程序。</p>
<blockquote>
<p><strong>建议按照顺序阅读本系列文章：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-1.md">微前端：未来前端开发的新趋势 — 第一部分</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-2.md">微前端：未来前端开发的新趋势 — 第二部分</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-3.md">微前端：未来前端开发的新趋势 — 第三部分</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-4.md">微前端：未来前端开发的新趋势 — 第四部分</a></li>
</ul>
</blockquote>
<h2 id="跨应用通信"><a href="#跨应用通信" class="headerlink" title="跨应用通信"></a>跨应用通信</h2><p>关于微前端最常见的问题就是如何让它们互相交流。一般来说，我们建议通信越少越好，因为这通常会重新引入不恰当的耦合，而这种耦合是我们首先想要避免的。</p>
<p>也就是说，某种程度上的通信通常是需要的。<a href="(https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Creating_and_triggering_events)">自定义事件</a>允许微前端直接通信，这是最小化直接耦合的好方法，虽然它确实使确定和执行微前端之间存在的约定变得更加困难。另外，向下传递回调和数据（在这里是从容器应用向下到微前端）的 React 模型也是一种好方法，它使得约定更加明确。第三种方法是使用地址栏作为通信机制，后面我们会谈到<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/micro-frontends.html#Cross-applicationCommunicationViaRouting">更多细节</a>。</p>
<blockquote>
<p>如果你在使用 redux，常用的方法是建立一个对于整个应用单一、全局、共享的 store。然而，如果微前端都应该是它自己的独立应用，那么它们每个都有自己的 redux store 是有意义的。Redux 文档甚至提到<a target="_blank" rel="noopener" href="https://redux.js.org/faq/store-setup#can-or-should-i-create-multiple-stores-can-i-import-my-store-directly-and-use-it-in-components-myself">“将 Redux 应用程序隔离为更大应用程序中的组件”</a>作为拥有多个 store 的正当理由。</p>
</blockquote>
<p>无论选择哪种方式，我们希望微前端通过发送消息或者事件来彼此通信，避免任何状态共享。就像跨微服务共享数据库，只要我们共享数据结构和领域模型，就会产生大量的耦合，这会变得非常难以维护。</p>
<p>与样式一样，有几种不同的方法可以在这方面起到很好的作用。最重要的事情是对你正在引入的耦合考虑深远，以及你将如何保持约定。就像微服务之间的集成一样，如果没有跨不同应用程序和团队的协调升级过程，你就无法对集成做出重大变更。</p>
<p>你也应该考虑如何自动验证集成没有挂掉。功能测试是一种方式，但我们更希望限制编写功能测试的数量，以便控制实现和维护它们的成本。或者你可以实施某种形式的<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/consumerDrivenContracts.html">消费者驱动的约定</a>，这样每个微前端可以指定它对于其他微前端的依赖，无需在浏览器中实际集成和运行它们。</p>
<hr>
<h2 id="后端通信"><a href="#后端通信" class="headerlink" title="后端通信"></a>后端通信</h2><p>如果我们有独立的团队在前端应用程序上独立工作，那么后端开发呢？我们非常相信全栈团队的价值，他们从可视化代码到 API 开发、数据库和基础架构代码负责整个应用的开发。<a target="_blank" rel="noopener" href="https://samnewman.io/patterns/architectural/bff/">BFF</a> 模式在这里发挥了作用，每一个前端应用都有一个对应的后端来单独满足前端的需求。虽然 BFF 模式最初可能意味着每个前端通道（web、mobile 等）的专用后端，它可以很容易地扩展为每一个微前端的后端。</p>
<p>这里有很多因素需要考虑。BFF 可能是自包含的，具有自己的业务逻辑和数据库，或者也可能只是一个下游服务的聚合器。如果有下游服务，那么拥有微前端及其 BFF 的团队可能有或可能没有意义，来拥有一些这样的服务。如果微前端只有一个与之通讯的 API ，并且它相当稳定，那么构建 BFF 就根本没有多大价值了。有一个指导原则是，团队构建一个特定微前端时不应该必须得等其他团队来为他们构建东西。因此如果每当给微前端添加新功能时也要求后端更改，那么由同一个团队拥有的 BFF 就是一个很好的案例。</p>
<p><img src="https://martinfowler.com/articles/micro-frontends/bff.png" alt="该图表显示三对前端/后端。第一个后端只与自己的数据库对话。其他两个后端与共享下游服务进行通信。两种方法都是有效的"></p>
<p>图 7：有很多不同的方式构建你的前/后端关系</p>
<p>其他常见问题有，应该如何通过服务器对微前端应用的用户进行身份验证和授权？明显我们的用户应该只需要认证一次，因此鉴权通常成为属于容器应用拥有的广泛关注的问题。容器可能有某种登录形式，我们通过它获得某种令牌。令牌由容器保存，可以在初始化时注入到每个微前端中。最终，微前端可以在任何发送给服务器的请求中携带令牌，然后服务器就可以执行任何需要的验证。</p>
<hr>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在测试方面，我们认为笨重前端和微前端之间没有太大区别。通常来讲，你用来测试笨重前端的任何策略都可以应用于每个微前端。也就是说，每个微前端都应该有自己全面的自动化测试套件来保证代码的质量和正确性。</p>
<p>明显的障碍是各种微前端与容器应用的集成测试。这个可以使用你喜欢的功能/端对端测试工具（比如 Selenium 或 Cypress）来完成，但是不要过度使用。功能测试应该只涵盖无法在<a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/TestPyramid.html">测试金字塔</a>较低级别测试的方面。我们的意思是，使用单元测试涵盖低级别业务逻辑和渲染逻辑，功能测试只用来验证页面是否正确渲染。例如，你可以在特定 URL 上加载完全集成的应用程序，并断言相应微前端的硬编码标题出现在页面上。</p>
<p>如果用户的使用跨越微前端，那么你可以用功能测试来测试这些，但要保证功能测试专注于验证前端的整合，而不是每个微前端的内部业务逻辑，这应该已经被单元测试所涵盖。<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/micro-frontends.html#Cross-applicationCommunication">正如刚才提到的</a>，用户驱动的约定有助于直接指定微前端之间发生的交互，而不会出现集成环境和功能测试的瑕疵。</p>
<hr>
<h2 id="案例详解"><a href="#案例详解" class="headerlink" title="案例详解"></a>案例详解</h2><p>本文后面的大部分内容将详细解释我们的示例应用程序实现的一种方式。我们将重点关注容器应用和微前端如何<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/micro-frontends.html#Run-timeIntegrationViaJavascript">使用 JavaScript 整合在一起</a>，这可能是最有趣也最复杂的部分。你可以在 <a target="_blank" rel="noopener" href="https://demo.microfrontends.com/">https://demo.microfrontends.com</a> 看到实时部署的最终结果，所有源代码都可以在 <a target="_blank" rel="noopener" href="https://github.com/micro-frontends-demo">Github</a> 上看到。</p>
<p><img src="https://martinfowler.com/articles/micro-frontends/screenshot-browse.png" alt="整个微前端示例应用的首页“概览”截图"></p>
<p>图 8：整个微前端示例应用的首页“概览”</p>
<p>该示例完全使用 React 开发，有必要说明的是，React <strong>没有</strong>垄断这个架构。可以使用许多不同的工具或框架来实现微前端。这里我们使用 React 是因为它的受欢迎程度以及我们对它的熟悉程度。</p>
<h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><p>我们从<a target="_blank" rel="noopener" href="https://github.com/micro-frontends-demo/container">容器</a>开始，因为它是我们用户的入口。让我们从它的 <code>package.json</code> 中看看可以发现什么：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;@micro-frontends-demo/container&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;Entry point and container for a micro frontends demo&quot;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;start&quot;: &quot;PORT=3000 react-app-rewired start&quot;,</span><br><span class="line">    &quot;build&quot;: &quot;react-app-rewired build&quot;,</span><br><span class="line">    &quot;test&quot;: &quot;react-app-rewired test&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;react&quot;: &quot;^16.4.0&quot;,</span><br><span class="line">    &quot;react-dom&quot;: &quot;^16.4.0&quot;,</span><br><span class="line">    &quot;react-router-dom&quot;: &quot;^4.2.2&quot;,</span><br><span class="line">    &quot;react-scripts&quot;: &quot;^2.1.8&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;devDependencies&quot;: &#123;</span><br><span class="line">    &quot;enzyme&quot;: &quot;^3.3.0&quot;,</span><br><span class="line">    &quot;enzyme-adapter-react-16&quot;: &quot;^1.1.1&quot;,</span><br><span class="line">    &quot;jest-enzyme&quot;: &quot;^6.0.2&quot;,</span><br><span class="line">    &quot;react-app-rewire-micro-frontends&quot;: &quot;^0.0.1&quot;,</span><br><span class="line">    &quot;react-app-rewired&quot;: &quot;^2.1.1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;config-overrides-path&quot;: &quot;node_modules/react-app-rewire-micro-frontends&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 <code>react</code> 和 <code>react-scripts</code> 依赖可以看出它是通过 <a target="_blank" rel="noopener" href="https://facebook.github.io/create-react-app/"><code>create-react-app</code></a> 创建的 React 应用。更有趣的是那<strong>没有</strong>的：任何提及我们将要组成以形成我们的最终应用程序的微前端。如果我们在这里将它们指定为库依赖项，那么我们将走向构建时集成的道路，那就会<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/micro-frontends.html#Build-timeIntegration">像之前提到的</a>会导致在我们的发布周期中有问题的耦合。</p>
<blockquote>
<p><code>react-scripts</code> 1.x 版本可以在单个页面中拥有多个应用而不产生冲突，但在 2.x 版本使用一些 webpack 特性，当两个以上应用在单个页面渲染时会导致错误。基于这个原因我们使用 <code>react-app-rewired</code> 覆盖一些 webpack 内部的 <code>react-scripts</code> 配置。它会修复这些错误，让我们继续依靠 <code>react-scripts</code> 来管理我们的构建工具。</p>
</blockquote>
<p>为了了解我们如何选择和展示微前端，我们来看一下 <code>App.js</code>。我们使用 <a target="_blank" rel="noopener" href="https://reacttraining.com/react-router/">React Router</a> 将当前 URL 与预定义的路由列表进行匹配，并且渲染相应组件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Switch&gt;</span><br><span class="line">  &lt;Route exact path=&quot;/&quot; component=&#123;Browse&#125; /&gt;</span><br><span class="line">  &lt;Route exact path=&quot;/restaurant/:id&quot; component=&#123;Restaurant&#125; /&gt;</span><br><span class="line">  &lt;Route exact path=&quot;/random&quot; render=&#123;Random&#125; /&gt;</span><br><span class="line">&lt;/Switch&gt;</span><br></pre></td></tr></table></figure>

<p><code>Random</code> 组件不那么有趣 —— 它只是重定向到随机选择的餐厅 URL 对应的页面。<code>Browse</code> 和 <code>Restaurant</code> 是这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const Browse = (&#123; history &#125;) =&gt; (</span><br><span class="line">  &lt;MicroFrontend history=&#123;history&#125; name=&quot;Browse&quot; host=&#123;browseHost&#125; /&gt;</span><br><span class="line">);</span><br><span class="line">const Restaurant = (&#123; history &#125;) =&gt; (</span><br><span class="line">  &lt;MicroFrontend history=&#123;history&#125; name=&quot;Restaurant&quot; host=&#123;restaurantHost&#125; /&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这两种情况，我们渲染 <code>MicroFrontend</code> 组件。除了 history 对象（后面会变得重要），我们指定应用的唯一名称，以及 bundle 下载的主机地址。在本地运行时，这个配置驱动的 URL 类似于 <code>http://localhost:3001</code>，生产环境则类似 <code>https://browse.demo.microfrontends.com</code>。</p>
<p>在 <code>App.js</code> 中选择了一个微前端，现在我们将在 <code>MicroFrontend.js</code> 渲染它，这只是另一个 React 组件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class MicroFrontend extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return &lt;main id=&#123;`$&#123;this.props.name&#125;-container`&#125; /&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这不是完整的类，我们很快会看到它更多的方法。</p>
<p>渲染时，我们要做的就是在页面上放置带有微前端唯一 ID 的容器元素。这是我们告诉微前端渲染自己的地方。我们使用 React 的 <code>componentDidMount</code> 作为下载和渲染微前端的触发器：</p>
<blockquote>
<p><code>componentDidMount</code> 是 React 组件的生命周期函数，它只会在组件实例首次在 DOM 中“渲染”时被框架调用。</p>
</blockquote>
<p>MicroFrontend 类……</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  const &#123; name, host &#125; = this.props;</span><br><span class="line">  const scriptId = `micro-frontend-script-$&#123;name&#125;`;</span><br><span class="line"></span><br><span class="line">  if (document.getElementById(scriptId)) &#123;</span><br><span class="line">    this.renderMicroFrontend();</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fetch(`$&#123;host&#125;/asset-manifest.json`)</span><br><span class="line">    .then(res =&gt; res.json())</span><br><span class="line">    .then(manifest =&gt; &#123;</span><br><span class="line">      const script = document.createElement(&#x27;script&#x27;);</span><br><span class="line">      script.id = scriptId;</span><br><span class="line">      script.src = `$&#123;host&#125;$&#123;manifest[&#x27;main.js&#x27;]&#125;`;</span><br><span class="line">      script.onload = this.renderMicroFrontend;</span><br><span class="line">      document.head.appendChild(script);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们必须从静态清单文件中获取脚本的 URL，因为 <code>react-scripts</code> 输出的编译后 JavaScript 文件名中包含便于缓存的哈希值。</p>
</blockquote>
<p>首先我们检查有唯一 ID 的相关脚本是否已经下载，如果下载了，我们可以立即渲染它。如果没有，我们获取从适当的主机获取 <code>asset-manifest.json</code> 文件，以便查找主脚本资产的完整 URL。一旦我们设置了脚本的 URL，剩下的就是将它附加到文档中，使用 <code>onload</code> 处理程序渲染微前端：</p>
<p>MicroFrontend 类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">renderMicroFrontend = () =&gt; &#123;</span><br><span class="line">  const &#123; name, history &#125; = this.props;</span><br><span class="line"></span><br><span class="line">  window[`render$&#123;name&#125;`](`$&#123;name&#125;-container`, history);</span><br><span class="line">  // E.g.: window.renderBrowse(&#x27;browse-container, history&#x27;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中我们调用了 <code>window.renderBrowse</code> 全局函数，它被我们刚刚下载的脚本放在那里。我们给微前端应该渲染的 <code>&lt;main&gt;</code> 元素分配一个 ID 和 <code>history</code> 对象，我们很快会解释。<strong>这个全局函数的签名是容器应用和微前端之间的关键约定</strong>。这是任何通讯或集成应该发生的地方，因此保持它相当轻量级使其易于维护，并在未来添加新的微前端。每当我们想要做一些需要更改此代码的事情时，我们应该仔细地思考它对于我们的代码库的耦合以及约定的维护意味着什么。</p>
<p>最后一件是处理清理工作。当我们的 <code>MicroFrontend</code> 组件卸载时（从 DOM 中移除），我们也想卸载相应的微前端。为此，每个微前端都定义了一个相应的全局函数，我们在适当的 React 生命周期方法中调用它：</p>
<p>MicroFrontend 类……</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">componentWillUnmount() &#123;</span><br><span class="line">  const &#123; name &#125; = this.props;</span><br><span class="line"></span><br><span class="line">  window[`unmount$&#123;name&#125;`](`$&#123;name&#125;-container`);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就它本身的内容而言，容器直接渲染的所有内容是网站的顶层头部和导航栏，因为这些在所有页面中都是不变的。这些元素的 CSS 已经过仔细编写，以确保它只对标题中的元素进行样式化，所以它不应该与微前端内的任何样式代码冲突。</p>
<p>这就是容器应用的结尾！它相当初级，但这给了我们一个 shell，可以在运行时动态下载我们的微前端，并将它们粘合在一起形成一个单一页面上的内容。这些微前端可以单独部署在生产上，无需改变任何其他微前端或容器本身。</p>
<blockquote>
<p><strong>建议按照顺序阅读本系列文章：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-1.md">微前端：未来前端开发的新趋势 — 第一部分</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-2.md">微前端：未来前端开发的新趋势 — 第二部分</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-3.md">微前端：未来前端开发的新趋势 — 第三部分</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-4.md">微前端：未来前端开发的新趋势 — 第四部分</a></li>
</ul>
</blockquote>
<blockquote>
<p>如果发现译文存在错误或其他需要改进的地方，欢迎到 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a> 对译文进行修改并 PR，也可获得相应奖励积分。文章开头的 <strong>本文永久链接</strong> 即为本文在 GitHub 上的 MarkDown 链接。</p>
</blockquote>
<hr>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a> 是一个翻译优质互联网技术文章的社区，文章来源为 <a target="_blank" rel="noopener" href="https://juejin.im/">掘金</a> 上的英文分享文章。内容覆盖 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#android">Android</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#ios">iOS</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%89%8D%E7%AB%AF">前端</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%90%8E%E7%AB%AF">后端</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%8C%BA%E5%9D%97%E9%93%BE">区块链</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E4%BA%A7%E5%93%81">产品</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E8%AE%BE%E8%AE%A1">设计</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD">人工智能</a>等领域，想要查看更多优质译文请持续关注 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a>、<a target="_blank" rel="noopener" href="http://weibo.com/juejinfanyi">官方微博</a>、<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/juejinfanyi">知乎专栏</a>。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2019/06/17/2019/%E3%80%90%E8%AF%91%E3%80%91Javascript-%E7%AE%80%E6%98%8E%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/06/17/2019/%E3%80%90%E8%AF%91%E3%80%91Javascript-%E7%AE%80%E6%98%8E%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">【译】JavaScript 简明代码 —— 最佳实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-17 23:10:14" itemprop="dateCreated datePublished" datetime="2019-06-17T23:10:14+00:00">2019-06-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 15:09:23" itemprop="dateModified" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%8E%98%E9%87%91%E7%BF%BB%E8%AF%91%E8%AE%A1%E5%88%92/" itemprop="url" rel="index"><span itemprop="name">掘金翻译计划</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<ul>
<li>原文地址：<a target="_blank" rel="noopener" href="https://devinduct.com/blogpost/22/javascript-clean-code-best-practices">JavaScript Clean Code - Best Practices</a></li>
<li>原文作者：<a target="_blank" rel="noopener" href="https://devinduct.com/">Milos Protic</a></li>
<li>译文出自：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a></li>
<li>本文永久链接：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/javascript-clean-code-best-practices.md">https://github.com/xitu/gold-miner/blob/master/TODO1/javascript-clean-code-best-practices.md</a></li>
<li>译者：<a target="_blank" rel="noopener" href="https://github.com/xilihuasi">xilihuasi</a></li>
<li>校对者：<a target="_blank" rel="noopener" href="https://github.com/smilemuffie">smilemuffie</a>、<a target="_blank" rel="noopener" href="https://github.com/Xuyuey">Xuyuey</a></li>
</ul>
</blockquote>
<h1 id="JavaScript-简明代码-——-最佳实践"><a href="#JavaScript-简明代码-——-最佳实践" class="headerlink" title="JavaScript 简明代码 —— 最佳实践"></a>JavaScript 简明代码 —— 最佳实践</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>如果你不只是担心你的代码是否能生效，还会关注代码本身及其如何编写，那你可以说你有在关注简明代码并在努力实践。专业的开发者会面向其未来和<strong>其他人</strong>而不仅是为了机器编写代码。你写的任何代码都不会只写一次，而是会待在那等待未来维护代码的人，让他痛苦不堪。希望那个未来的家伙不会是你。</p>
<p>基于上述情况，简明代码可以被定义为<strong>代码以不言自明，易于理解且易于更改或扩展的方式编写</strong>。</p>
<p>回想一下有多少次你接手别人工作时的第一印象是下面几个 <strong>WTF</strong> 问题之一？</p>
<p><strong>“这 TM 是啥？”</strong></p>
<p><strong>“你 TM 在这干了啥”</strong></p>
<p><strong>“这 TM 是干啥的？”</strong></p>
<p>有一个很火的图片描绘了上述场景。</p>
<p><img src="https://camo.githubusercontent.com/2050cd696ecddcabad1380b1964c48a60597323e/687474703a2f2f7777772e6f736e6577732e636f6d2f696d616765732f636f6d6963732f7774666d2e6a7067" alt="img"></p>
<p><strong>Robert C. Martin (Bob 叔叔)</strong> 的一句名言应该会启发你思考你的方式。</p>
<blockquote>
<p><strong>即使是糟糕的代码也能运行。但是如果代码不够简明，它会让开发组织陷入困境。</strong></p>
</blockquote>
<p>在本文中，重点将放在 JavaScript 上，但是原则可以应用于其他编程语言。</p>
<h2 id="你要的干货来了-——-简明代码最佳实践"><a href="#你要的干货来了-——-简明代码最佳实践" class="headerlink" title="你要的干货来了 —— 简明代码最佳实践"></a>你要的干货来了 —— 简明代码最佳实践</h2><h3 id="1-强类型检查"><a href="#1-强类型检查" class="headerlink" title="1. 强类型检查"></a>1. 强类型检查</h3><p>使用 <code>===</code> 而不是 <code>==</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果处理不当，它会在很大程度上影响程序逻辑。就像，你期待向左走，但由于某些原因，你向右走了。</span></span><br><span class="line"><span class="number">0</span> == <span class="literal">false</span>; <span class="comment">// true</span></span><br><span class="line"><span class="number">0</span> === <span class="literal">false</span>; <span class="comment">// false</span></span><br><span class="line"><span class="number">2</span> == <span class="string">&#x27;2&#x27;</span>; <span class="comment">// true</span></span><br><span class="line"><span class="number">2</span> === <span class="string">&#x27;2&#x27;</span>; <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 例子</span></span><br><span class="line"><span class="keyword">const</span> value = <span class="string">&#x27;500&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (value === <span class="number">500</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">  <span class="comment">// 不会执行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (value === <span class="string">&#x27;500&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">  <span class="comment">// 会执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-变量"><a href="#2-变量" class="headerlink" title="2. 变量"></a>2. 变量</h3><p>变量命名要直接表明其背后的意图。这种方式方便代码搜索并且易于他人理解。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> daysSLV = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">let</span> y = <span class="keyword">new</span> <span class="built_in">Date</span>().getFullYear();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ok;</span><br><span class="line"><span class="keyword">if</span> (user.age &gt; <span class="number">30</span>) &#123;</span><br><span class="line">  ok = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MAX_AGE = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">let</span> daysSinceLastVisit = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">let</span> currentYear = <span class="keyword">new</span> <span class="built_in">Date</span>().getFullYear();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isUserOlderThanAllowed = user.age &gt; MAX_AGE;</span><br></pre></td></tr></table></figure>

<p>不要给变量名称添加不必要的单词。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> nameValue;</span><br><span class="line"><span class="keyword">let</span> theProduct;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> name;</span><br><span class="line"><span class="keyword">let</span> product;</span><br></pre></td></tr></table></figure>

<p>不要强制他人记住变量的上下文。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> users = [<span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;Marco&#x27;</span>, <span class="string">&#x27;Peter&#x27;</span>];</span><br><span class="line">users.forEach(<span class="function">(<span class="params">u</span>) =&gt;</span> &#123;</span><br><span class="line">  doSomething();</span><br><span class="line">  doSomethingElse();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 这里有 WTF 场景：`u` TM 是啥？</span></span><br><span class="line">  register(u);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> users = [<span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;Marco&#x27;</span>, <span class="string">&#x27;Peter&#x27;</span>];</span><br><span class="line">users.forEach(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">  doSomething();</span><br><span class="line">  doSomethingElse();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  register(user);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>不要添加不必要的上下文。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">userName</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">  <span class="attr">userSurname</span>: <span class="string">&quot;Doe&quot;</span>,</span><br><span class="line">  <span class="attr">userAge</span>: <span class="string">&quot;28&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">user.userName;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">  <span class="attr">surname</span>: <span class="string">&quot;Doe&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="string">&quot;28&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">user.name;</span><br></pre></td></tr></table></figure>

<h3 id="3-函数"><a href="#3-函数" class="headerlink" title="3. 函数"></a>3. 函数</h3><p>使用长而具有描述性的名称。考虑到它代表某种行为，函数名称应该是暴露其背后意图的动词或者短语，参数也是如此。它们的名称应该表明它们要做什么。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notif</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notifyUser</span>(<span class="params">emailAddress</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>避免使用大量参数。理想情况下，函数参数不应该超过两个。参数越少，函数越易于测试。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUsers</span>(<span class="params">fields, fromDate, toDate</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUsers</span>(<span class="params">&#123; fields, fromDate, toDate &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getUsers(&#123;</span><br><span class="line">  <span class="attr">fields</span>: [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;surname&#x27;</span>, <span class="string">&#x27;email&#x27;</span>],</span><br><span class="line">  <span class="attr">fromDate</span>: <span class="string">&#x27;2019-01-01&#x27;</span>,</span><br><span class="line">  <span class="attr">toDate</span>: <span class="string">&#x27;2019-01-18&#x27;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>使用默认参数代替条件语句。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createShape</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> shapeType = type || <span class="string">&#x27;cube&#x27;</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createShape</span>(<span class="params">type = <span class="string">&#x27;cube&#x27;</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个函数应该只做一件事。禁止在单个函数中执行多个操作。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notifyUsers</span>(<span class="params">users</span>) </span>&#123;</span><br><span class="line">  users.forEach(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> userRecord = database.lookup(user);</span><br><span class="line">    <span class="keyword">if</span> (userRecord.isVerified()) &#123;</span><br><span class="line">      notify(user);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notifyVerifiedUsers</span>(<span class="params">users</span>) </span>&#123;</span><br><span class="line">  users.filter(isUserVerified).forEach(notify);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isUserVerified</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> userRecord = database.lookup(user);</span><br><span class="line">  <span class="keyword">return</span> userRecord.isVerified();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>Object.assign</code> 设置默认对象。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shapeConfig = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;cube&#x27;</span>,</span><br><span class="line">  <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="attr">height</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createShape</span>(<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.type = config.type || <span class="string">&#x27;cube&#x27;</span>;</span><br><span class="line">  config.width = config.width || <span class="number">250</span>;</span><br><span class="line">  config.height = config.width || <span class="number">250</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createShape(shapeConfig);</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shapeConfig = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;cube&quot;</span>,</span><br><span class="line">  <span class="attr">width</span>: <span class="number">200</span></span><br><span class="line">  <span class="comment">// Exclude the &#x27;height&#x27; key</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createShape</span>(<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config = <span class="built_in">Object</span>.assign(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;cube&quot;</span>,</span><br><span class="line">      <span class="attr">width</span>: <span class="number">250</span>,</span><br><span class="line">      <span class="attr">height</span>: <span class="number">250</span></span><br><span class="line">    &#125;,</span><br><span class="line">    config</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createShape(shapeConfig);</span><br></pre></td></tr></table></figure>

<p>不要使用标志变量作为参数，因为这表明函数做了它不应该做的事。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFile</span>(<span class="params">name, isPublic</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isPublic) &#123;</span><br><span class="line">    fs.create(<span class="string">`./public/<span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fs.create(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFile</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  fs.create(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPublicFile</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  createFile(<span class="string">`./public/<span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不要污染全局变量。如果你要扩展一个已存在的对象，使用 ES 类继承而不是在原生对象的原型链上创建函数。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.myFunc = <span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperArray</span> <span class="keyword">extends</span> <span class="title">Array</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">myFunc</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// implementation</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-条件语句"><a href="#4-条件语句" class="headerlink" title="4. 条件语句"></a>4. 条件语句</h3><p>避免使用否定条件。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isUserNotBlocked</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isUserNotBlocked(user)) &#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isUserBlocked</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isUserBlocked(user)) &#123;</span><br><span class="line">  <span class="comment">// implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用条件语句简写。这可能不那么重要，但是值得一提。仅将此方法用于布尔值，并且确定该值不是 <code>undefined</code> 和 <code>null</code>。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isValid === <span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isValid === <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isValid) &#123;</span><br><span class="line">  <span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">  <span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽可能避免条件语句，使用多态和继承。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="title">getMaximumSpeed</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">this</span>.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Ford&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.someFactor() + <span class="built_in">this</span>.anotherFactor();</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Mazda&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.someFactor();</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;McLaren&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.someFactor() - <span class="built_in">this</span>.anotherFactor();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ford</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="title">getMaximumSpeed</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.someFactor() + <span class="built_in">this</span>.anotherFactor();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mazda</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="title">getMaximumSpeed</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.someFactor();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">McLaren</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="title">getMaximumSpeed</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.someFactor() - <span class="built_in">this</span>.anotherFactor();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-ES-类"><a href="#5-ES-类" class="headerlink" title="5. ES 类"></a>5. ES 类</h3><p>类是 JavaScript 中的新语法糖。一切都像之前使用原型一样现在只不过看起来不同，并且你应该喜欢它们胜过 ES5 普通函数。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Person = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="built_in">this</span> <span class="keyword">instanceof</span> Person)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Instantiate Person with `new` keyword&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person.prototype.sayHello = <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/**/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Student = <span class="function"><span class="keyword">function</span> (<span class="params">name, school</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="built_in">this</span> <span class="keyword">instanceof</span> Student)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Instantiate Student with `new` keyword&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Person.call(<span class="built_in">this</span>, name);</span><br><span class="line">  <span class="built_in">this</span>.school = school;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Student.prototype = <span class="built_in">Object</span>.create(Person.prototype);</span><br><span class="line">Student.prototype.constructor = Student;</span><br><span class="line">Student.prototype.printSchoolName = <span class="function"><span class="keyword">function</span> <span class="title">printSchoolName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/**/</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">sayHello</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, school</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(name);</span><br><span class="line">    <span class="built_in">this</span>.school = school;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">printSchoolName</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用方法链。诸如 jQuery 和 Lodash 之类的很多库都使用这个模式。这样的话，你的代码就会减少冗余。在你的类中，只用在每个函数末尾返回 <code>this</code>，然后你就可以在它上面链式调用更多的类方法了。</p>
<p>糟糕示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setSurname</span>(<span class="params">surname</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.surname = surname;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setAge</span>(<span class="params">age</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">save</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name, <span class="built_in">this</span>.surname, <span class="built_in">this</span>.age);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> Person(<span class="string">&#x27;John&#x27;</span>);</span><br><span class="line">person.setSurname(<span class="string">&#x27;Doe&#x27;</span>);</span><br><span class="line">person.setAge(<span class="number">29</span>);</span><br><span class="line">person.save();</span><br></pre></td></tr></table></figure>

<p>良好示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setSurname</span>(<span class="params">surname</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.surname = surname;</span><br><span class="line">    <span class="comment">// Return this for chaining</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setAge</span>(<span class="params">age</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">    <span class="comment">// Return this for chaining</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">save</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.name, <span class="built_in">this</span>.surname, <span class="built_in">this</span>.age);</span><br><span class="line">    <span class="comment">// Return this for chaining</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> Person(<span class="string">&#x27;John&#x27;</span>).setSurname(<span class="string">&#x27;Doe&#x27;</span>).setAge(<span class="number">29</span>).save();</span><br></pre></td></tr></table></figure>

<h3 id="6-通用原则"><a href="#6-通用原则" class="headerlink" title="6. 通用原则"></a>6. 通用原则</h3><p>一般来说，你应该尽力不要重复自己的工作，意思是你不应该写重复代码，并且不要在你身后留下尾巴比如未使用的函数和死代码。</p>
<p>出于各种原因，你最终可能会遇到重复的代码。例如，你有两个大致相同只有些许不同的东西，它们不同的特性或者时间紧迫使你单独创建了两个包含几乎相同代码的函数。在这种情况下删除重复代码意味着抽象化差异并在该层级上处理它们。</p>
<p>关于死代码，码如其名。它是在我们代码库中不做任何事情的代码，在开发的某个阶段，你决定它不再有用了。你应该在代码库中搜索这些部分然后删除所有不需要的函数和代码块。我可以给你的建议是一旦你决定不再需要它，删除它。不然你就会忘了它的用途。</p>
<p>这有一张图表明你当时可能会有的感受。</p>
<p><img src="https://pics.me.me/sometimes-my-code-dont-know-what-it-does-but-i-49866360.png" alt="img"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>这只是改进代码所能做的一小部分。在我看来，这里所说的原则是人们经常不遵循的原则。他们有过尝试，但由于各种原因并不总是奏效。可能项目刚开始代码还是整洁的，但当截止日期快到了，这些原则通常会被忽略，被移入“<strong>待办</strong>”或者“<strong>重构</strong>”部分。在那时候，客户宁愿让你赶上截止日期而不是写简明的代码。</p>
<p>就这样！</p>
<p>感谢阅读，下篇文章见。</p>
<blockquote>
<p>如果发现译文存在错误或其他需要改进的地方，欢迎到 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a> 对译文进行修改并 PR，也可获得相应奖励积分。文章开头的 <strong>本文永久链接</strong> 即为本文在 GitHub 上的 MarkDown 链接。</p>
</blockquote>
<hr>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a> 是一个翻译优质互联网技术文章的社区，文章来源为 <a target="_blank" rel="noopener" href="https://juejin.im/">掘金</a> 上的英文分享文章。内容覆盖 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#android">Android</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#ios">iOS</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%89%8D%E7%AB%AF">前端</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%90%8E%E7%AB%AF">后端</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%8C%BA%E5%9D%97%E9%93%BE">区块链</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E4%BA%A7%E5%93%81">产品</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E8%AE%BE%E8%AE%A1">设计</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD">人工智能</a>等领域，想要查看更多优质译文请持续关注 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a>、<a target="_blank" rel="noopener" href="http://weibo.com/juejinfanyi">官方微博</a>、<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/juejinfanyi">知乎专栏</a>。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2019/04/09/2019/%E3%80%90%E8%AF%91%E3%80%912019-React-Redux-%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/04/09/2019/%E3%80%90%E8%AF%91%E3%80%912019-React-Redux-%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">【译】2019 React Redux 完全指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-09 20:24:27" itemprop="dateCreated datePublished" datetime="2019-04-09T20:24:27+00:00">2019-04-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 15:09:23" itemprop="dateModified" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%8E%98%E9%87%91%E7%BF%BB%E8%AF%91%E8%AE%A1%E5%88%92/" itemprop="url" rel="index"><span itemprop="name">掘金翻译计划</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<ul>
<li>原文地址：<a target="_blank" rel="noopener" href="https://daveceddia.com/redux-tutorial/">A Complete React Redux Tutorial for 2019</a></li>
<li>原文作者：<a target="_blank" rel="noopener" href="https://daveceddia.com/">Dave Ceddia</a></li>
<li>译文出自：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a></li>
<li>本文永久链接：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/redux-tutorial.md">https://github.com/xitu/gold-miner/blob/master/TODO1/redux-tutorial.md</a></li>
<li>译者：<a target="_blank" rel="noopener" href="https://github.com/xilihuasi">xilihuasi</a></li>
<li>校对者：<a target="_blank" rel="noopener" href="https://github.com/xionglong58">xionglong58</a>、<a target="_blank" rel="noopener" href="https://github.com/Fengziyin1234">Fengziyin1234</a></li>
</ul>
</blockquote>
<h1 id="2019-React-Redux-完全指南"><a href="#2019-React-Redux-完全指南" class="headerlink" title="2019 React Redux 完全指南"></a>2019 React Redux 完全指南</h1><p><img src="https://daveceddia.com/images/complete-redux-tutorial-2019.png" alt="A Complete Redux Tutorial (2019): why use it? - store - reducers - actions - thunks - data fetching"></p>
<p>想要理解 Redux 完整的工作机制真的让人头疼。特别是作为初学者。</p>
<p>术语太多了！Actions、reducers、action creators、middleware、pure functions、immutability、thunks 等等。</p>
<p>怎么把这些全都与 React 结合起来构建一个可运行的应用？</p>
<p>你可以花几个小时阅读博客以及尝试从复杂的“真实世界”应用中研习以将它拼凑起来。</p>
<p>在本篇 Redux 教程中，我会渐进地解释如何将 Redux 与 React 搭配使用 —— 从简单的 React 开始 —— 以及一个非常简单的 React + Redux 案例。我会解释<strong>为什么</strong>每个功能都很有用（以及什么情况下做取舍）。</p>
<p>接着我们会看到更加进阶的内容，手把手，直到你<strong>全部</strong>都理解为止。我们开始吧 :)</p>
<p>请注意：本教程<strong>相当齐全</strong>。也就意味篇幅着<strong>比较长</strong>。我把它变成了一个完整的免费课程，<strong>并且</strong>我制作了精美的 PDF 你可以在 iPad 或【任何 Android 设备】上阅读。留下你的邮箱地址即可立即获取。</p>
<h2 id="视频概述-Redux-要点"><a href="#视频概述-Redux-要点" class="headerlink" title="视频概述 Redux 要点"></a>视频概述 Redux 要点</h2><p>如果你更喜欢看视频而不是阅读，这个视频涵盖了如何在 React 应用中一步步添加 Redux：</p>
<p><a target="_blank" rel="noopener" href="https://youtu.be/sX3KeP7v7Kg">视频地址</a></p>
<p>这与本教程的第一部分相似，我们都会在一个简单 React 应用中逐步地添加 Redux。</p>
<p>或者，继续看下去！本教程不仅涵盖视频中的所有内容，还有其他干货。</p>
<h2 id="你应该用-Redux-吗？"><a href="#你应该用-Redux-吗？" class="headerlink" title="你应该用 Redux 吗？"></a>你应该用 Redux 吗？</h2><p>都 9102 年了，弄清楚你是否还应该使用 Redux 十分必要。现在有更好的替代品出现吗，使用 Hooks，Context 还是其他库？</p>
<p>简而言之：即使有很多替代品，<a target="_blank" rel="noopener" href="https://blog.isquaredsoftware.com/2018/03/redux-not-dead-yet/">Redux 仍旧不死</a>。但是是否适用于你的应用，还得看具体场景。</p>
<p>超级简单？只有一两个地方需要用到几个 state？组件内部 state 就很好了。你可以通过 classes，<a target="_blank" rel="noopener" href="https://daveceddia.com/intro-to-hooks/">Hooks</a> 或者二者一起来实现。</p>
<p>再复杂一点，有一些“全局”的东西需要在整个应用中共享？<a target="_blank" rel="noopener" href="https://daveceddia.com/context-api-vs-redux/">Context API</a> 可能完美适合你。</p>
<p>很多全局的 state，与应用的各独立部分都有交互？或者一个大型应用并且随着时间推移只会越来越大？试试 Redux 吧。</p>
<p>你也可以<strong>以后</strong>再使用 Redux，不必在第一天就决定。从简单开始，在你需要的时候再增加复杂性。</p>
<h3 id="你知道-React-吗？"><a href="#你知道-React-吗？" class="headerlink" title="你知道 React 吗？"></a>你知道 React 吗？</h3><p>React 可以脱离 Redux 单独使用。Redux 是 React 的<strong>附加项</strong>。</p>
<p>即使你打算同时使用它们，我还是强烈建议先<strong>脱离</strong> Redux 学习纯粹的 React。理解 props，state 以及单向数据流，在学习 Redux 之前先学习 “React 编程思想”。同时学习这两个肯定会把你搞晕。</p>
<p>如果你想要入门 React ，我整理了一个为期 5 天的免费课程，教授所有基础知识：</p>
<p>接下来的 5 天通过构建一些简单的应用来学习 React。</p>
<p>第一课</p>
<h2 id="Redux-的好处"><a href="#Redux-的好处" class="headerlink" title="Redux 的好处"></a>Redux 的好处</h2><p>如果你稍微使用过一段时间的 React，你可能就了解了 props 和单向数据流。数据通过 props 在组件树间向<strong>下</strong>传递。就像这个组件一样：</p>
<p><img src="https://daveceddia.com/images/counter-component.png" alt="Counter component"></p>
<p><code>count</code> 存在 <code>App</code> 的 state 里，会以 prop 的形式向下传递：</p>
<p><img src="https://daveceddia.com/images/passing-props-down.png" alt="Passing props down"></p>
<p>要想数据向<strong>上</strong>传递，需要通过回调函数实现，因此必须首先将回调函数向<strong>下</strong>传递到任何想通过调用它来传递数据的组件中。</p>
<p><img src="https://daveceddia.com/images/passing-callbacks-down.png" alt="Passing callbacks down"></p>
<p>你可以把数据想象成<strong>电流</strong>，通过彩色电线连接需要它的组件。数据通过线路上下流动，但是线路不能在空气中贯穿 —— 它们必须从一个组件连接到另一个组件。</p>
<h3 id="多级传递数据是一种痛苦"><a href="#多级传递数据是一种痛苦" class="headerlink" title="多级传递数据是一种痛苦"></a>多级传递数据是一种痛苦</h3><p>迟早你会陷入这类场景，顶级容器组件有一些数据，有一个 4 级以上的子组件需要这些数据。这有一个 Twitter 的例子，所有头像都圈出来了：</p>
<p><img src="https://daveceddia.com/images/twitter-user-data.png" alt="Twitter user data"></p>
<p>我们假设根组件 <code>App</code> 的 state 有 <code>user</code> 对象。该对象包含当前用户头像、昵称和其他资料信息。</p>
<p>为了把 <code>user</code> 数据传递给全部 3 个 <code>Avatar</code> 组件，必须要经过一堆并不需要该数据的中间组件。</p>
<p><img src="https://daveceddia.com/images/twitter-hierarchy.png" alt="Sending the user data down to the Avatar components"></p>
<p>获取数据就像用针在采矿探险一样。等等，那根本没有意义。无论如何，<strong>这很痛苦</strong>。也被称为 “prop-drilling”。</p>
<p>更重要的是，这不是好的软件设计。中间组件被迫接受和传递他们并不关心的 props。也就意味着重构和重用这些组件会变得比原本更难。</p>
<p>如果不需要这些数据的组件根本不用看到它们的话不是很棒吗？</p>
<p>Redux 就是解决这个问题的一种方法。</p>
<h3 id="相邻组件间的数据传递"><a href="#相邻组件间的数据传递" class="headerlink" title="相邻组件间的数据传递"></a>相邻组件间的数据传递</h3><p>如果你有些兄弟组件需要共享数据，React 的方式是把数据向<strong>上</strong>传到父组件中，然后再通过 props 向下传递。</p>
<p>但这可能很麻烦。Redux 会为你提供一个可以存储数据的全局 “parent”，然后你可以通过 React-Redux 把兄弟组件和数据 <code>connect</code> 起来。</p>
<h3 id="使用-React-Redux-将数据连接到任何组件"><a href="#使用-React-Redux-将数据连接到任何组件" class="headerlink" title="使用 React-Redux 将数据连接到任何组件"></a>使用 React-Redux 将数据连接到任何组件</h3><p>使用 <code>react-redux</code> 的 <code>connect</code> 函数，你可以将任何组件插入 Redux 的 store 以及取出需要的数据。</p>
<p><img src="https://daveceddia.com/images/redux-connected-twitter.png" alt="Connecting Redux to the Avatar components"></p>
<p>Redux 还做了一些很酷的事情，比如使调试更轻松（Redux DevTools 让你检查每一个 state 的变化），time-travel debugging（你可以<strong>回滚</strong> state 变化，看看你的应用以前的样子），从长远来看，它让代码变得更易于维护。它也会教你更多关于函数式编程的知识。</p>
<h2 id="内置-Redux-替代品"><a href="#内置-Redux-替代品" class="headerlink" title="内置 Redux 替代品"></a>内置 Redux 替代品</h2><p>如果 Redux 对你来说太过繁琐了，可以看看这些替代品。它们内置在 React 中。</p>
<h3 id="Redux-替代品-The-React-Context-API"><a href="#Redux-替代品-The-React-Context-API" class="headerlink" title="Redux 替代品: The React Context API"></a>Redux 替代品: The React Context API</h3><p>在底层，React-Redux 使用 React 内置的 Context API 来传递数据。如果你愿意，你可以跳过 Redux 直接使用 Context。你会错过上面提到的 Redux 很棒的特性，但是如果你的应用很简单并且想用简单的方式传递数据，Context 就够了。</p>
<p>既然你读到这里，我认为你真想学习 Redux，我不会在这里<a target="_blank" rel="noopener" href="https://daveceddia.com/context-api-vs-redux/">比较 Redux 和 Context API</a> 或者<a target="_blank" rel="noopener" href="https://daveceddia.com/usecontext-hook/">使用 Context</a> 和<a target="_blank" rel="noopener" href="https://daveceddia.com/usereducer-hook-examples/">使用 Reducer</a> Hooks。你可以点击链接详细了解。</p>
<p>如果你想深入研究 Context API，看我在 egghead 的课程 <a target="_blank" rel="noopener" href="https://egghead.io/courses/react-context-for-state-management">React Context 状态管理</a></p>
<h3 id="其他替代品：使用-children-Prop"><a href="#其他替代品：使用-children-Prop" class="headerlink" title="其他替代品：使用 children Prop"></a>其他替代品：使用 <code>children</code> Prop</h3><p>取决于你构建应用程序的方式，你可能会用更直接的方式把数据传递给子组件，那就是使用 <code>children</code> 和其他 props 结合的方式作为“插槽”。如果你组织的方式正确，就可以有效地跳过层次结构中的几个层级。</p>
<p>我有一篇相关文章 <a target="_blank" rel="noopener" href="https://daveceddia.com/pluggable-slots-in-react-components/">“插槽”模式以及如何组织组件树</a> 来有效地传递数据。</p>
<h2 id="学习-Redux，从简单-React-开始"><a href="#学习-Redux，从简单-React-开始" class="headerlink" title="学习 Redux，从简单 React 开始"></a>学习 Redux，从简单 React 开始</h2><p>我们将采用增量的方法，从带有组件 state 的简单 React 应用开始，一点点添加 Redux，以及解决过程中遇到的错误。我们称之为“错误驱动型开发” :)</p>
<p>这是一个计数器：</p>
<p><img src="https://daveceddia.com/images/counter-plain.png" alt="Counter component"></p>
<p>这本例中，Counter 组件有 state，包裹着它的 App 是一个简单包装器。</p>
<p>Counter.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">  increment = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="built_in">this</span>.state.count + <span class="number">1</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  decrement = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="built_in">this</span>.state.count - <span class="number">1</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Counter<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.decrement&#125;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.increment&#125;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Counter;</span><br></pre></td></tr></table></figure>

<p>快速回顾一下，它是如何运行的：</p>
<ul>
<li><code>count</code> state 存储在 <code>Counter</code> 组件</li>
<li>当用户点击 “+” 时，会调用按钮的 <code>onClick</code> 处理器执行 <code>increment</code> 函数。</li>
<li><code>increment</code> 函数会更新 state 的 count 值。</li>
<li>因为 state 改变了，React 会重新渲染 <code>Counter</code> 组件（以及它的子元素），这样就会显示新计数值。</li>
</ul>
<p>如果你想要了解 state 变化机制的更多细节，去看 <a target="_blank" rel="noopener" href="https://daveceddia.com/visual-guide-to-state-in-react/">React 中的 state 可视指南</a>然后再回到这里。</p>
<p>不过说实话：如果上面内容对你来讲<strong>不是</strong>复习的话，你需要在学 Redux <strong>之前</strong>了解下 React 的 state 如何工作，否则你会巨困惑。参加我<a target="_blank" rel="noopener" href="https://daveceddia.com/pure-react-email-course">免费的 5 天 React 课程</a>，用简单的 React 获得信心，然后再回到这里。</p>
<h3 id="跟上来！"><a href="#跟上来！" class="headerlink" title="跟上来！"></a>跟上来！</h3><p>最好的学习方式就是动手尝试！所以这有个 CodeSandbox 你可以跟着做：</p>
<p>–&gt; <a target="_blank" rel="noopener" href="https://codesandbox.io/s/98153xy79w">在新 tab 中打开 CodeSandbox</a></p>
<p>我强烈建议你将 CodeSandbox 与该教程保持同步并且随着你进行时实际动手敲出这些例子。</p>
<h2 id="在-React-应用中添加-Redux"><a href="#在-React-应用中添加-Redux" class="headerlink" title="在 React 应用中添加 Redux"></a>在 React 应用中添加 Redux</h2><p>在 CodeSandbox 中，展开左侧的 Dependencies 选项，然后点击 Add Dependency。</p>
<p>搜索 <code>redux</code> 添加依赖，然后再次点击 Add Dependency 搜索 <code>react-redux</code> 添加。</p>
<p><img src="https://daveceddia.com/images/add-redux-in-codesandbox.gif"></p>
<p>在本地项目，你可以通过 Yarn 或者 NPM 安装：<code>npm install --save redux react-redux</code>。</p>
<h3 id="redux-vs-react-redux"><a href="#redux-vs-react-redux" class="headerlink" title="redux vs react-redux"></a>redux vs react-redux</h3><p><code>redux</code> 给你一个 store，让你可以在里面保存 state，取出 state，以及当 state 发生改变时做出响应。但那就是它所有能做的事。</p>
<p>实际上是 <code>react-redux</code> 把各个 state 和 React 组件连接起来。</p>
<p>没错：<code>redux</code> 对 React <strong>根本</strong>不了解。</p>
<p>虽然，这两个库就像豆荚里的两个豌豆。99.999% 的情况下，当任何人在 React 的场景下提到 “Redux”，他们指的是这两个库。因此当你在 StackOverflow、Reddit 或者其他地方看到 Redux 时，记住这一点。</p>
<p><code>redux</code> 库可以脱离 React 应用使用。它可以和 Vue、Angular 甚至后端的 Node/Express 应用一起使用。</p>
<h2 id="Redux-有全局唯一-Store"><a href="#Redux-有全局唯一-Store" class="headerlink" title="Redux 有全局唯一 Store"></a>Redux 有全局唯一 Store</h2><p>我们将首先从 Redux 中的一小部分入手：store。</p>
<p>我们已经讨论过 Redux 怎样在一个独立 store 里保存你应用的 state。以及怎样提取 state 的一部分把它作为 props 嵌入你的组件。</p>
<p>你会经常看到 “state” 和 “store” 这两个词互换使用。技术上来讲，state 是数据，store 是保存数据的地方。</p>
<p>因此：作为我们从简单的 React 到 Redux 重构的第一步，我们要创建一个 store 来保持 state。</p>
<h2 id="创建-Redux-Store"><a href="#创建-Redux-Store" class="headerlink" title="创建 Redux Store"></a>创建 Redux Store</h2><p>Redux 有一个很方便的函数用来创建 stores，叫做 <code>createStore</code>。很合逻辑，嗯？</p>
<p>我们在 <code>index.js</code> 中创建一个 store。引入 <code>createStore</code> 然后像这样调用：</p>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function">() =&gt;</span> (</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这样会遇到 “Expected the reducer to be a function.” 错误。</p>
<p><img src="https://daveceddia.com/images/error-expected-reducer-to-be-a-function.png" alt="Error: Expected the reducer to be a function."></p>
<h3 id="Store-需要一个-Reducer"><a href="#Store-需要一个-Reducer" class="headerlink" title="Store 需要一个 Reducer"></a>Store 需要一个 Reducer</h3><p>因此，有件关于 Redux 的事：它并不是非常智能。</p>
<p>你可能期待通过创建一个 store，它会给你的 state 一个合适的默认值。或许是一个空对象？</p>
<p>但是并非如此。这里没有约定优于配置。</p>
<p>Redux <strong>不会</strong>对你的 state 做任何假设。它可能是一个 object、number、string，或者任何你需要的。这取决于你。</p>
<p>我们必须提供一个返回 state 的函数。这个函数被称为 reducer（我们马上就知道为什么了）。那么我们创建一个非常简单的 reducer，把它传给 <code>createStore</code>，然后看会发生什么：</p>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;reducer&#x27;</span>, state, action);</span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer);</span><br></pre></td></tr></table></figure>

<p>修改完后，打开控制台（在 CodeSandbox 里，点击底部的 Console 按钮）。</p>
<p>你应该可以看到类似这样的日志信息：</p>
<p><img src="https://daveceddia.com/images/reducer-console-log.png" alt="reducer undefined Object { type: @@redux/INIT }"></p>
<p>（INIT 后面的字母和数字是 Redux 随机生成的）</p>
<p>注意在你创建 store 的同时 Redux 如何调用你的 reducer。（为了证实这点：调用 <code>createStore</code> 之后立即输出 <code>console.log</code>，看看 reducer 后面会打印什么）</p>
<p>同样注意 Redux 如何传递了一个 <code>undefined</code> 的 <code>state</code>，同时 action 是一个有 <code>type</code> 属性的对象。</p>
<p>我们稍后会更多地讨论 actions。现在，我们先看看 <strong>reducer</strong>。</p>
<h2 id="Redux-Reducer-是什么？"><a href="#Redux-Reducer-是什么？" class="headerlink" title="Redux Reducer 是什么？"></a>Redux Reducer 是什么？</h2><p>“reducer” 术语看起来可能有点陌生和害怕，但是本节过后，我认为你会同意如下观点，正如俗话所说的那样，“只是一个函数”。</p>
<p>你用过数组的 <code>reduce</code> 函数吗？</p>
<p>它是这样用的：你传入一个函数，遍历数组的每一个元素时都会调用你传入的函数，类似 <code>map</code> 的作用 —— 你可能在 React 里面渲染列表而对 <code>map</code> 很熟悉。</p>
<p>你的函数调用时会接收两个参数：上一次迭代的结果，和当前数组元素。它结合当前元素和之前的 “total” 结果然后返回新的 total 值。</p>
<p>结合下面例子看会更加清晰明了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> letters = [<span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;x&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// `reduce` 接收两个参数:</span></span><br><span class="line"><span class="comment">//   - 一个用来 reduce 的函数 (也称为 &quot;reducer&quot;)</span></span><br><span class="line"><span class="comment">//   - 一个计算结果的初始值</span></span><br><span class="line"><span class="keyword">var</span> word = letters.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">accumulatedResult, arrayItem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> accumulatedResult + arrayItem;</span><br><span class="line">&#125;, <span class="string">&#x27;&#x27;</span>); <span class="comment">// &lt;-- 注意这个空字符串：它是初始值</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(word); <span class="comment">// =&gt; &quot;redux&quot;</span></span><br></pre></td></tr></table></figure>

<p>你给 <code>reduce</code> 传入的函数理所应当被叫做 “reducer”，因为它将整个数组的元素 <strong>reduces</strong> 成一个结果。</p>
<p>Redux <strong>基本上</strong>是数组 <code>reduce</code> 的豪华版。前面，你看到 Redux reducers 如何拥有这个显著特征：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(state, action) =&gt; newState;</span><br></pre></td></tr></table></figure>

<p>含义：它接收当前 <code>state</code> 和一个 <code>action</code>，然后返回 <code>newState</code>。看起来很像 <code>Array.reduce</code> 里 reducer 的特点！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(accumulatedValue, nextItem) =&gt; nextAccumulatedValue;</span><br></pre></td></tr></table></figure>

<p>Redux reducers 就像你传给 Array.reduce 的函数作用一样！:) 它们 reduce 的是 actions。它们把一组 actions（随着时间）reduce 成一个单独的 state。不同之处在于 Array 的 reduce 立即发生，而 Redux 则随着正运行应用的生命周期一直发生。</p>
<p>如果你仍然非常不确定，查看下我的 [Redux reducers 工作机制]指南(<a target="_blank" rel="noopener" href="https://daveceddia.com/what-is-a-reducer/)%E3%80%82%E4%B8%8D%E7%84%B6%E7%9A%84%E8%AF%9D%EF%BC%8C%E6%88%91%E4%BB%AC%E7%BB%A7%E7%BB%AD%E5%90%91%E4%B8%8B%E7%9C%8B%E3%80%82">https://daveceddia.com/what-is-a-reducer/)。不然的话，我们继续向下看。</a></p>
<h2 id="给-Reducer-一个初始状态"><a href="#给-Reducer-一个初始状态" class="headerlink" title="给 Reducer 一个初始状态"></a>给 Reducer 一个初始状态</h2><p>记住 reducer 的职责是接收当前 <code>state</code> 和一个 <code>action</code> 然后返回新的 state。</p>
<p>它还有另一个职责：在首次调用的时候应该返回初始 state。它有点像应用的“引导页”。它必须从某处开始，对吧？</p>
<p>惯用的方式是定义一个 <code>initialState</code> 变量然后使用 ES6 默认参数给 <code>state</code> 赋初始值。</p>
<p>既然要把 <code>Counter</code> state 迁移到 Redux，我们先立马创建它的初始 state。在 <code>Counter</code> 组件里，我们的 state 是一个有 <code>count</code> 属性的对象，所以我们在这创建一个一样的 initialState。</p>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;reducer&#x27;</span>, state, action);</span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你再看下控制台，你会看到 <code>state</code> 打印的值为 <code>&#123;count: 0&#125;</code>。那就是我们想要的。</p>
<p>所以这告诉我们一条关于 reducers 的重要规则。</p>
<p>Reducers 重要规则一：reducer 绝不能返回 undefined。</p>
<p>通常 state 应该总是已定义的。已定义的 state 是良好的 state。而<strong>未</strong>定义的则<strong>不</strong>那么好（并且会破坏你的应用）。</p>
<h2 id="Dispatch-Actions-来改变-State"><a href="#Dispatch-Actions-来改变-State" class="headerlink" title="Dispatch Actions 来改变 State"></a>Dispatch Actions 来改变 State</h2><p>是的，一下来了两个名字：我们将 “dispatch” 一些 “actions”。</p>
<h3 id="什么是-Redux-Action？"><a href="#什么是-Redux-Action？" class="headerlink" title="什么是 Redux Action？"></a>什么是 Redux Action？</h3><p>在 Redux 中，具有 <code>type</code> 属性的普通对象就被称为 action。就是这样，只要遵循这两个规则，它就是一个 action：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;add an item&quot;</span>,</span><br><span class="line">  <span class="attr">item</span>: <span class="string">&quot;Apple&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is also an action:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="number">7008</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here’s another one:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Actions 的格式非常自由。只要它是个带有 <code>type</code> 属性的对象就可以了。</p>
<p>为了保证事务的合理性和可维护性，我们 Redux 用户通常给 actions 的 type 属性赋简单字符串，并且通常是大写的，来表明它们是常量。</p>
<p>Action 对象描述你想做出的改变（如“增加 counter”）或者将触发的事件（如“请求服务失败并显示错误信息”）。</p>
<p>尽管 Actions 名声响亮，但它是无趣的，呆板的对象。它们事实上不<strong>做</strong>任何事情。反正它们自己不做。</p>
<p>为了让 action <strong>做</strong>点事情，你需要 dispatch。</p>
<h2 id="Redux-Dispatch-工作机制"><a href="#Redux-Dispatch-工作机制" class="headerlink" title="Redux Dispatch 工作机制"></a>Redux Dispatch 工作机制</h2><p>我们刚才创建的 store 有一个内置函数 <code>dispatch</code>。调用的时候携带 action，Redux 调用 reducer 时就会携带 action（然后 reducer 的返回值会更新 state）。</p>
<p>我们在 store 上试试看。</p>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(reducer);</span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;);</span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;);</span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;DECREMENT&#x27;</span> &#125;);</span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;RESET&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>在你的 CodeSandbox 中添加这些 dispatch 调用然后检查控制台</p>
<p><img src="https://daveceddia.com/images/dispatching-redux-actions.png" alt="reducer undefined Object { type: @@redux/INIT }"></p>
<p>每一次调用 <code>dispatch</code> 最终都会调用 reducer！</p>
<p>同样注意到 state 每次都一样？<code>&#123;count: 0&#125;</code> 一直没变。</p>
<p>这是因为我们的 reducer 没有<strong>作用于</strong>那些 actions。不过很容易解决。现在就开始吧。</p>
<h2 id="在-Redux-Reducer-中处理-Actions"><a href="#在-Redux-Reducer-中处理-Actions" class="headerlink" title="在 Redux Reducer 中处理 Actions"></a>在 Redux Reducer 中处理 Actions</h2><p>为了让 actions 做点事情，我们需要在 reducer 里面写几行代码来根据每个 action 的 <code>type</code> 值来对应得更新 state。</p>
<p>有几种方式实现。</p>
<p>你可以创建一个对象来通过 action 的 type 来查找对应的处理函数。</p>
<p>或者你可以写一大堆 if/else 语句</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(action.type === <span class="string">&quot;INCREMENT&quot;</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(action.type === <span class="string">&quot;RESET&quot;</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者你可以用一个简单的 <code>switch</code> 语句，也是我下面采用的方式，因为它很直观，也是这种场景的常用方法。</p>
<p>尽管有些人讨厌 <code>switch</code>，如果你也是 —— 随意用你喜欢的方式写 reducers 就好 :)</p>
<p>下面是我们处理 actions 的逻辑：</p>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;reducer&#x27;</span>, state, action);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;INCREMENT&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">count</span>: state.count + <span class="number">1</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;DECREMENT&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">count</span>: state.count - <span class="number">1</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;RESET&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>试一下然后在控制台看看会输出什么。</p>
<p><img src="https://daveceddia.com/images/handling-redux-actions.png" alt="reducer undefined Object { type: @@redux/INIT }"></p>
<p>快看！<code>count</code> 变了!</p>
<p>我们准备好把它连接到 React 了，在此之前让我们先谈谈这段 reducer 代码。</p>
<h2 id="如何保持纯-Reducers"><a href="#如何保持纯-Reducers" class="headerlink" title="如何保持纯 Reducers"></a>如何保持纯 Reducers</h2><p>另一个关于 reducers 的规则是它们必须是纯函数。也就是说不能修改它们的参数，也不能有副作用（side effect）。</p>
<p>Reducer 规则二：Reducers 必须是纯函数。</p>
<p>“副作用（side effect）”是指对函数作用域之外的任何更改。不要改变函数作用域以外的变量，不要调用其他会改变的函数（比如 <code>fetch</code>，跟网络和其他系统有关），也不要 dispatch actions 等。</p>
<p>技术角度来看 <code>console.log</code> 是副作用（side effect），但是我们忽略它。</p>
<p>最重要的事情是：不要修改 <code>state</code> 参数。</p>
<p>这意味着你不能执行 <code>state.count = 0</code>、<code>state.items.push(newItem)</code>、<code>state.count++</code> 及其他类型的变动 —— 不要改变 <code>state</code> 本身，及其任何子属性。</p>
<p>你可以把它想成一个游戏，你唯一能做的事就是 <code>return &#123; ... &#125;</code>。这是个有趣的游戏。开始会有点恼人。但是通过练习你会变得更好。</p>
<p>我整理了一个<a target="_blank" rel="noopener" href="https://daveceddia.com/react-redux-immutability-guide/">如何在 Redux 里做 Immutable 更新</a>完全指南，包含更新 state 中对象和数组的七个通用模式。</p>
<p>安装 <a target="_blank" rel="noopener" href="https://github.com/mweststrate/immer">Immer</a> 在 reducers 里面使用也是一种很好的方式。Immer 让你可以像写普通 mutable 代码一样，最终会自动生成 immutable 代码。<a target="_blank" rel="noopener" href="https://daveceddia.com/react-redux-immutability-guide/#easy-state-updates-with-immer">点击了解如何使用 Immer</a>。</p>
<p>建议：如果你是开始一个全新的应用程序，一开始就使用 Immer。它会为你省去很多麻烦。但是我向你展示这种<strong>困难</strong>方式是因为很多代码仍然采用这种方式，你一定会看到没有用 Immer 写的 reducers</p>
<h2 id="全部规则"><a href="#全部规则" class="headerlink" title="全部规则"></a>全部规则</h2><p>必须返回一个 state，不要改变 state，不要 connect 每一个组件，要吃西兰花，11 点后不要外出…这简直没完没了。就像一个规则工厂，我甚至不知道那是什么。</p>
<p>是的，Redux 就像一个霸道的父母。但它是出于爱。函数式编程的爱。</p>
<p>Redux 建立在不变性的基础上，因为变化的全局 state 是一条通往废墟之路。</p>
<p>你试过在全局对象里面保存你的 state 吗？起初它还很好。美妙并且简单。任何东西都能接触到 state 因为它一直是可用的并且很容易更改。</p>
<p>然后 state 开始以不可预测的方式发生改变，想要找到改变它的代码变得几乎不可能。</p>
<p>为了避免这些问题，Redux 提出了以下规则。</p>
<ul>
<li>State 是只读的，唯一修改它的方式是 actions。</li>
<li>更新的唯一方式：dispatch(action) -&gt; reducer -&gt; new state。</li>
<li>Reducer 函数必须是“纯”的 —— 不能修改它的参数，也不能有副作用（side effect）。</li>
</ul>
<h2 id="如何在-React-中使用-Redux"><a href="#如何在-React-中使用-Redux" class="headerlink" title="如何在 React 中使用 Redux"></a>如何在 React 中使用 Redux</h2><p>此时我们有个很小的带有 <code>reducer</code> 的 <code>store</code>，当接收到 <code>action</code> 时它知道如何更新 <code>state</code>。</p>
<p>现在是时候将 Redux 连接到 React 了。</p>
<p>要做到这一点，要用到 <code>react-redux</code> 库的两样东西：一个名为 <code>Provider</code> 的组件和一个 <code>connect</code> 函数。</p>
<p>通过用 <code>Provider</code> 组件包装整个应用，如果它想的话，应用树里的<strong>每一个组件</strong>都可以访问 Redux store。</p>
<p>在 <code>index.js</code> 里，引入 <code>Provider</code> 然后用它把 <code>App</code> 的内容包装起来。<code>store</code> 会以 prop 形式传递。</p>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function">() =&gt;</span> (</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Counter</span>/&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这样之后，<code>Counter</code>， <code>Counter</code> 的子元素，以及子元素的子元素等等——所有这些现在都可以访问 Redux stroe。</p>
<p>但不是自动的。我们需要在我们的组件使用 <code>connect</code> 函数来访问 store。</p>
<h3 id="React-Redux-Provider-工作机制"><a href="#React-Redux-Provider-工作机制" class="headerlink" title="React-Redux Provider 工作机制"></a>React-Redux Provider 工作机制</h3><p><code>Provider</code> 可能看起来有一点点像魔法。它在底层实际是用了 React 的 <a target="_blank" rel="noopener" href="https://daveceddia.com/context-api-vs-redux/">Context 特性</a>。</p>
<p>Context 就像是连接每个组件的秘密通道，使用 <code>connect</code> 就可打开秘密通道的大门。</p>
<p>想象一下，在一堆煎饼上浇糖浆以及它铺满<strong>所有</strong>煎饼的方式，即使你只在最上层倒了糖浆。<code>Provider</code> 对 Redux 做了同样的事情。</p>
<h2 id="为-Redux-准备-Counter-组件"><a href="#为-Redux-准备-Counter-组件" class="headerlink" title="为 Redux 准备 Counter 组件"></a>为 Redux 准备 Counter 组件</h2><p>现在 Counter 有了内部 state。我们打算把它干掉，为从 Redux 以 prop 方式获取 <code>count</code> 做准备。</p>
<p>移除顶部的 state 初始化，以及 <code>increment</code> 和 <code>decrement</code> 内部调用的 <code>setState</code>。然后，把 <code>this.state.count</code> 替换成 <code>this.props.count</code>。</p>
<p>Counter.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// state = &#123; count: 0 &#125;; // 删除</span></span><br><span class="line"></span><br><span class="line">  increment = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    // 删除</span></span><br><span class="line"><span class="comment">    this.setState(&#123;</span></span><br><span class="line"><span class="comment">      count: this.state.count + 1</span></span><br><span class="line"><span class="comment">    &#125;);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  decrement = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    // 同样删除</span></span><br><span class="line"><span class="comment">    this.setState(&#123;</span></span><br><span class="line"><span class="comment">      count: this.state.count - 1</span></span><br><span class="line"><span class="comment">    &#125;);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;counter&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Counter<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.decrement&#125;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">&#x27;count&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml">            &#123;</span></span><br><span class="line"><span class="xml">              // 把 state:</span></span><br><span class="line"><span class="xml">              //// this.state.count</span></span><br><span class="line"><span class="xml">              // 替换成:</span></span><br><span class="line"><span class="xml">              this.props.count</span></span><br><span class="line"><span class="xml">            &#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.increment&#125;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在 <code>increment</code> 和 <code>decrement</code> 是空的。我们会很快再次填充它们。</p>
<p>你会注意到 count 消失了 —— 它确实应该这样，因为目前还没有给 <code>Counter</code> 传递 <code>count</code> prop。</p>
<h2 id="连接组件和-Redux"><a href="#连接组件和-Redux" class="headerlink" title="连接组件和 Redux"></a>连接组件和 Redux</h2><p>要从 Redux 获取 <code>count</code>，我们首先需要在 Counter.js 顶部引入 <code>connect</code> 函数。</p>
<p>Counter.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>然后我们需要在底部把 Counter 组件和 Redux 连接起来：</p>
<p>Counter.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加这个函数:</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">count</span>: state.count,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后把:</span></span><br><span class="line"><span class="comment">// export default Counter;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换成:</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps)(Counter);</span><br></pre></td></tr></table></figure>

<p>之前我们只导出了组件本身。现在我们用 <code>connect</code> 函数调用把它包装起来，这样我们就可以导出<strong>已连接的</strong> Counter。至于应用的其余部分，看起来就像一个常规组件。</p>
<p>然后 count 应该就重新出现了！直到我们重新实现 increment/decrement，它是不会变化的。</p>
<h2 id="如何使用-React-Redux-connect"><a href="#如何使用-React-Redux-connect" class="headerlink" title="如何使用 React Redux connect"></a>如何使用 React Redux <code>connect</code></h2><p>你可能注意到这个调用看起来有点……奇怪。为什么是 <code>connect(mapStateToProps)(Counter)</code> 而不是 <code>connect(mapStateToProps, Counter)</code> 或者 <code>connect(Counter, mapStateToProps)</code>？它做了什么？</p>
<p>这样写是因为 <code>connect</code> 是一个<strong>高阶函数</strong>，它简单说就是当你调用它时会返回一个函数。然后调用<strong>返回的</strong>函数传入一个组件时，它会返回一个新（包装的）组件。</p>
<p>它的另一个名称是 <a target="_blank" rel="noopener" href="https://daveceddia.com/extract-state-with-higher-order-components/"><strong>高阶组件</strong></a> (简称 “HOC”)。HOCs 过去曾有过一些糟糕的新闻，但它仍然是一个相当有用的模式，<code>connect</code> 就是一个很好的例子。</p>
<p><code>Connect</code> 做的是在 Redux 内部 hook，取出整个 state，然后把它传进你提供的 <code>mapStateToProps</code> 函数。它是个自定义函数，因为只有<strong>你</strong>知道你存在 Redux 里面的 state 的“结构”。</p>
<h2 id="mapStateToProps-工作机制"><a href="#mapStateToProps-工作机制" class="headerlink" title="mapStateToProps 工作机制"></a>mapStateToProps 工作机制</h2><p><code>connect</code> 把整个 state 传给了你的 <code>mapStateToProps</code> 函数，就好像在说，“嘿，告诉我你想从这堆东西里面要什么。”</p>
<p><code>mapStateToProps</code> 返回的对象以 props 形式传给了你的组件。以上面为例就是把 <code>state.count</code> 的值用 <code>count</code> prop 传递：对象的属性变成了 prop 名称，它们对应的值会变成 props 的值。你看，这个函数就像字面含义一样<strong>定义从 state 到 props 的映射</strong>。</p>
<p>顺便说说 —— <code>mapStateToProps</code> 的名称是使用惯例，但并不是特定的。你可以简写成 <code>mapState</code> 或者用任何你想的方式调用。只要你接收 <code>state</code> 对象然后返回全是 props 的对象，那就没问题。</p>
<h3 id="为什么不传整个-state？"><a href="#为什么不传整个-state？" class="headerlink" title="为什么不传整个 state？"></a>为什么不传整个 state？</h3><p>在上面的例子中，我们的 state 结构<strong>已经</strong>是对的了，看起来 <code>mapDispatchToProps</code> 可能是不必要的。如果你实质上复制参数（state）给一个跟 state 相同的对象，这有什么意义呢？</p>
<p>在很小的例子中，可能会传全部 state，但通常你只会从更大的 state 集合中选择部分组件需要的数据。</p>
<p>并且，没有 <code>mapStateToProps</code> 函数，<code>connect</code> 不会传递任何 state。</p>
<p>你<strong>可以</strong>传整个 state，然后让组件梳理。但那不是一个很好的习惯，因为组件需要知道 Redux state 的结构然后从中挑选它需要的数据，后面如果你想更改结构会变得更难。</p>
<h2 id="从-React-组件-Dispatch-Redux-Actions"><a href="#从-React-组件-Dispatch-Redux-Actions" class="headerlink" title="从 React 组件 Dispatch Redux Actions"></a>从 React 组件 Dispatch Redux Actions</h2><p>现在我们的 Counter 已经被 <code>connect</code> 了，我们也获取到了 <code>count</code> 值。现在我们如何 dispatch actions 来改变 count？</p>
<p>好吧，<code>connect</code> 为你提供支持：除了传递（mapped）state，它<strong>还</strong>从 store 传递了 <code>dispatch</code> 函数!</p>
<p>要在 Counter 内部 dispatch action，我们可以调用 <code>this.props.dispatch</code> 携带一个 action。</p>
<p>我们的 reducer 已经准备好处理 <code>INCREMENT</code> 和 <code>DECREMENT</code> actions 了，那么接下来从 increment/decrement 中 dispatch：</p>
<p>Counter.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">increment = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.props.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">decrement = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.props.dispatch(&#123; <span class="attr">type</span>: <span class="string">&#x27;DECREMENT&#x27;</span> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>现在我们完成了。按钮应该又重新生效了。</p>
<h3 id="试试这个！加一个重置按钮"><a href="#试试这个！加一个重置按钮" class="headerlink" title="试试这个！加一个重置按钮"></a>试试这个！加一个重置按钮</h3><p>这有个小练习：给 counter 添加“重置”按钮，点击时 dispatch “RESET” action。</p>
<p>Reducer 已经写好处理这个 action，因此你只需要修改 Counter.js。</p>
<h2 id="Action-常量"><a href="#Action-常量" class="headerlink" title="Action 常量"></a>Action 常量</h2><p>在大部分 Redux 应用中，你可以看到 action 常量都是一些简单字符串。这是一个额外的抽象级别，从长远来看可以为你节省不少时间。</p>
<p>Action 常量帮你避免错别字，action 命名的错别字会是一个巨大的痛苦：没有报错，没有哪里坏掉的明显标志，并且你的 action 没有做任何事情？那就可能是个错别字。</p>
<p>Action 常量很容易编写：用变量保存你的 action 字符串。</p>
<p>把这些变量放在一个 <code>actions.js</code> 文件里是个好办法（当你的应用很小时）。</p>
<p>actions.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INCREMENT = <span class="string">&#x27;INCREMENT&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DECREMENT = <span class="string">&#x27;DECREMENT&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>然后你就可以引入这些 action 名称，用它们来代替手写字符串：</p>
<p>Counter.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; INCREMENT, DECREMENT &#125; <span class="keyword">from</span> <span class="string">&#x27;./actions&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">  increment = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.dispatch(&#123; <span class="attr">type</span>: INCREMENT &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  decrement = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.dispatch(&#123; <span class="attr">type</span>: DECREMENT &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Redux-Action-生成器是什么？"><a href="#Redux-Action-生成器是什么？" class="headerlink" title="Redux Action 生成器是什么？"></a>Redux Action 生成器是什么？</h2><p>现在我们已经手写 action 对象。像个异教徒。</p>
<p>如果你有一个<strong>函数</strong>会为你编写它会怎么样？不要再误写 actinos 了！</p>
<p>我可以告诉你，这很疯狂。手写 <code>&#123; type: INCREMENT &#125;</code> 并保证没有弄乱有多困难？</p>
<p>当你的应用变得越来越大，actions 越来越多，并且这些 actions 开始变得更复杂 —— 要传更多数据而不仅是一个 <code>type</code> —— action 生成器会帮上大忙。</p>
<p>就像 action 常量一样，但它们不是<strong>必须品</strong>。这是另一层的抽象，如果你不想在你的应用里面使用，那也没关系。</p>
<p>不过我还是会解释下它们是什么。然后你可以决定你是否有时/总是/绝不想使用它们。</p>
<p>Actions 生成器在 Redex 术语中是一个简单的函数术语，它返回一个 action 对象。就这些 :)</p>
<p>这是其中两个，返回熟悉的 actions。顺便说一句，它们在 action 常量的 “actions.js” 中完美契合。</p>
<p>actions.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INCREMENT = <span class="string">&#x27;INCREMENT&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DECREMENT = <span class="string">&#x27;DECREMENT&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREMENT &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> decrement = <span class="function">() =&gt;</span> (&#123; <span class="attr">type</span>: DECREMENT &#125;);</span><br></pre></td></tr></table></figure>

<p>我用了两种不同方式——一个 <code>function</code> 和一个箭头函数——来表明你用哪种方式写并不重要。挑选你喜欢的方式就好。</p>
<p>你可能注意到函数命名是小写的（好吧，如果较长的话会是驼峰命名），而 action 常量会是 <code>UPPER_CASE_WITH_UNDERSCORES</code>。同样，这也只是惯例。这会让你一眼区分 action 生成器和 action 常量。但你也可以按你喜欢的方式命名。Redux 并不关心。</p>
<p>现在，如何使用 action 生成器呢？引入然后 dispatch 就好了，当然！</p>
<p>Counter.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; increment, decrement &#125; <span class="keyword">from</span> <span class="string">&#x27;./actions&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">  increment = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.dispatch(increment()); <span class="comment">// &lt;&lt; 在这使用</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  decrement = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.dispatch(decrement());</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键是要记得调用 action creator()！</p>
<p>不要 <code>dispatch(increment)</code> 🚫</p>
<p>应该 <code>dispatch(increment())</code> ✅</p>
<p>牢记 action 生成器是一个平凡无奇的函数。Dispatch 需要 action 是一个<strong>对象</strong>，而不是函数。</p>
<p>而且：你肯定会在这里出错并且非常困惑。至少一次，或许很多次。那很正常。我有时也<strong>依旧</strong>会忘记。</p>
<h2 id="如何使用-React-Redux-mapDispatchToProps"><a href="#如何使用-React-Redux-mapDispatchToProps" class="headerlink" title="如何使用 React Redux mapDispatchToProps"></a>如何使用 React Redux mapDispatchToProps</h2><p>现在你知道 action 生成器是什么，我们可以讨论<strong>又一个</strong>级别的抽象。（我知道，我<strong>知道</strong>。这是可选的。）</p>
<p>你知道 <code>connect</code> 如何传递 <code>dispatch</code> 函数吗？你知道你是如何厌倦一直敲 <code>this.props.dispatch</code> 并且它看起来多么混乱？（跟我来）</p>
<p>写一个 <code>mapDispatchToProps</code> 对象（或者函数！但通常是对象）然后传给你要包装组件的 <code>connect</code> 函数，你将收到这些 action 生成器作为<strong>可调用 props</strong>。看代码：</p>
<p>Counter.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; increment, decrement &#125; <span class="keyword">from</span> <span class="string">&#x27;./actions&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  increment = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 我们可以调用 `increment` prop,</span></span><br><span class="line">    <span class="comment">// 它会 dispatch action:</span></span><br><span class="line">    <span class="built_in">this</span>.props.increment();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  decrement = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.decrement();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">count</span>: state.count,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这个对象中, 属性名会成为 prop 的 names,</span></span><br><span class="line"><span class="comment">// 属性值应该是 action 生成器函数.</span></span><br><span class="line"><span class="comment">// 它们跟 `dispatch` 绑定起来.</span></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = &#123;</span><br><span class="line">  increment,</span><br><span class="line">  decrement,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Counter);</span><br></pre></td></tr></table></figure>

<p>这很棒，因为它把你从手动调用 <code>dispatch</code> 中解放出来。</p>
<p>你可以把 <code>mapDispatch</code> 写成一个函数，但是对象能满足 95% 你所需的场景。详细内容请看 <a target="_blank" rel="noopener" href="https://daveceddia.com/redux-mapdispatchtoprops-object-form/">函数式 mapDispatch 以及为什么你可能并不需要它</a>。</p>
<h2 id="如何使用-Redux-Thunk-获取数据"><a href="#如何使用-Redux-Thunk-获取数据" class="headerlink" title="如何使用 Redux Thunk 获取数据"></a>如何使用 Redux Thunk 获取数据</h2><p>既然 reducers 应该是“纯”的，我们不能做在 reducer 里面做任何 API 调用或者 dispatch actions。</p>
<p>我们也不能在 action 生成器里面做这些事！</p>
<p>但是如果我们把 action 生成器<strong>返回</strong>一个可以处理我们工作的函数会怎样呢？就像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">&#x27;/current_user&#x27;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>越界了，Redux 不支持这种 actions。固执的 Redux 只接受<strong>简单对象</strong>作为 actions。</p>
<p>这时就需要 redux-thunk 了。它是个中间件，基本是 Redux 的一个插件，它可以使 Redux 处理像上面 <code>getUser()</code> 那样的 actions。</p>
<p>你可以像其他 action 生成器一样 dispatch 这些 “thunk actions”：<code>dispatch(getUser())</code>。</p>
<h3 id="“thunk”-是什么？"><a href="#“thunk”-是什么？" class="headerlink" title="“thunk” 是什么？"></a>“thunk” 是什么？</h3><p>“thunk” 是（少见）指被其它函数作为返回值的<strong>函数</strong>。</p>
<p>在 Redux 术语中，它是一个返回值为函数而非简单 action 对象的 action 生成器，就像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doStuff</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">dispatch, getState</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 在这里 dispatch actions</span></span><br><span class="line">    <span class="comment">// 或者获取数据</span></span><br><span class="line">    <span class="comment">// 或者该干啥干啥</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从技术角度讲，被返回的函数就是 “thunk”，把它作为返回值的就是“action 生成器”。通常我把它们一起称为 “thunk action”。</p>
<p>Action 生成器返回的函数接收两个参数：<code>dispatch</code> 函数和 <code>getState</code>。</p>
<p>大多数场景你只需要 <code>dispatch</code>，但有时你想根据 Redux state 里面的值额外做些事情。这种情况下，调用 <code>getState()</code> 你就会获得整个 state 的值然后按需所取。</p>
<h2 id="如何安装-Redux-Thunk"><a href="#如何安装-Redux-Thunk" class="headerlink" title="如何安装 Redux Thunk"></a>如何安装 Redux Thunk</h2><p>使用 NPM 或者 Yarn 安装 redux-thunk，运行 <code>npm install --save redux-thunk</code>。</p>
<p>然后，在 index.js（或者其他你创建 store 的地方），引入 <code>redux-thunk</code> 然后通过 Redux 的 <code>applyMiddleware</code> 函数把它应用到 store 中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer, applyMiddleware(thunk));</span><br></pre></td></tr></table></figure>

<p>必须确保 <code>thunk</code> 包装在 <code>applyMiddleware</code> 调用里面，否则不会生效。不要直接传 <code>thunk</code>。</p>
<h2 id="结合-Redux-请求数据的例子"><a href="#结合-Redux-请求数据的例子" class="headerlink" title="结合 Redux 请求数据的例子"></a>结合 Redux 请求数据的例子</h2><p>设想一下你想展示一个产品列表。你已经获得了后端 API 可以响应 <code>GET /products</code>，所以你创建了一个 thunk action 来从后端请求数据：</p>
<p>productActions.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchProducts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    dispatch(fetchProductsBegin());</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">&#x27;/products&#x27;</span>)</span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>) =&gt;</span> res.json())</span><br><span class="line">      .then(<span class="function">(<span class="params">json</span>) =&gt;</span> &#123;</span><br><span class="line">        dispatch(fetchProductsSuccess(json.products));</span><br><span class="line">        <span class="keyword">return</span> json.products;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> dispatch(fetchProductsFailure(error)));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fetch(&quot;/products&quot;)</code> 是实际上请求数据的部分。然后我们在它前后分别做了一些 <code>dispatch</code> 调用。</p>
<h2 id="Dispatch-Action-来获取数据"><a href="#Dispatch-Action-来获取数据" class="headerlink" title="Dispatch Action 来获取数据"></a>Dispatch Action 来获取数据</h2><p>要开始调用并且实际获取数据，我们需要 dispatch <code>fetchProducts</code> action。</p>
<p>在哪里调用呢？</p>
<p>如果某一特定的组件需要数据，最好的调用地方通常是在组件刚刚加载<strong>之后</strong>，也就是它的 <code>componentDidMount</code> 生命周期函数。</p>
<p>或者，如果你在使用 Hooks，useEffect hook 里面也是个好地方。</p>
<p>有时你要获取整个应用都需要的真正的<strong>全局</strong>数据 —— 如“用户信息”或者“国际化”。这种场景，就在你创建 store 后使用 <code>store.dispatch</code> 来 dispatch action，而不是等待组件加载后。</p>
<h3 id="如何给-Redux-Actions-命名"><a href="#如何给-Redux-Actions-命名" class="headerlink" title="如何给 Redux Actions 命名"></a>如何给 Redux Actions 命名</h3><p>获取数据的 Redux actions 通常使用标准三连：BEGIN、SUCCESS、FAILURE。这不是硬性要求，只是惯例。</p>
<p>BEGIN/SUCCESS/FAILURE 模式很棒，因为它给你提供钩子来跟踪发生了什么 —— 比如，设置 “loading” 标志为 “true” 以响应 BEGIN 操作，在 SUCCESS 或 FAILURE 之后设为 <code>false</code>。</p>
<p>而且，与 Redux 中的其他所有内容一样，这个也是一个惯例，如果你不需要的话可以忽略掉。</p>
<p>在你调用 API <strong>之前</strong>，dispatch BEGIN action。</p>
<p>调用成功<strong>之后</strong>，你可以 dispatch SUCCESS 数据。如果请求失败，你可以 dispatch 错误信息。</p>
<p>有时最后一个调用 ERROR。其实调用什么一点也不重要，只要你保持一致就好。</p>
<p>注意：dispatch Error action 来处理 FAILURE 会导致你跟踪代码的时候毫无头绪，知道 action 正确 dispatch 但是数据却没更新。吸取我的教训 :)</p>
<p>这是那几个 actions，以及它们的 action 生成器：</p>
<p>productActions.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FETCH_PRODUCTS_BEGIN = <span class="string">&#x27;FETCH_PRODUCTS_BEGIN&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FETCH_PRODUCTS_SUCCESS = <span class="string">&#x27;FETCH_PRODUCTS_SUCCESS&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FETCH_PRODUCTS_FAILURE = <span class="string">&#x27;FETCH_PRODUCTS_FAILURE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchProductsBegin = <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">type</span>: FETCH_PRODUCTS_BEGIN,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchProductsSuccess = <span class="function">(<span class="params">products</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">type</span>: FETCH_PRODUCTS_SUCCESS,</span><br><span class="line">  <span class="attr">payload</span>: &#123; products &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchProductsFailure = <span class="function">(<span class="params">error</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">type</span>: FETCH_PRODUCTS_FAILURE,</span><br><span class="line">  <span class="attr">payload</span>: &#123; error &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>接收到 <code>FETCH_PRODUCTS_SUCCESS</code> action 返回的产品数据后，我们写一个 reducer 把它存进 Redux store 中。开始请求时把 <code>loading</code> 标志设为 true，失败或者完成时设为 false。</p>
<p>productReducer.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  FETCH_PRODUCTS_BEGIN,</span><br><span class="line">  FETCH_PRODUCTS_SUCCESS,</span><br><span class="line">  FETCH_PRODUCTS_FAILURE,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./productActions&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">items</span>: [],</span><br><span class="line">  <span class="attr">loading</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">error</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">productReducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> FETCH_PRODUCTS_BEGIN:</span><br><span class="line">      <span class="comment">// 把 state 标记为 &quot;loading&quot; 这样我们就可以显示 spinner 或者其他内容</span></span><br><span class="line">      <span class="comment">// 同样，重置所有错误信息。我们从新开始。</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">loading</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">error</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> FETCH_PRODUCTS_SUCCESS:</span><br><span class="line">      <span class="comment">// 全部完成：设置 loading 为 &quot;false&quot;。</span></span><br><span class="line">      <span class="comment">// 同样，把从服务端获取的数据赋给 items。</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">loading</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">items</span>: action.payload.products,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> FETCH_PRODUCTS_FAILURE:</span><br><span class="line">      <span class="comment">// 请求失败，设置 loading 为 &quot;false&quot;.</span></span><br><span class="line">      <span class="comment">// 保存错误信息，这样我们就可以在其他地方展示。</span></span><br><span class="line">      <span class="comment">// 既然失败了，我们没有产品可以展示，因此要把 `items` 清空。</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// 当然这取决于你和应用情况：</span></span><br><span class="line">      <span class="comment">// 或许你想保留 items 数据！</span></span><br><span class="line">      <span class="comment">// 无论如何适合你的场景就好。</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">loading</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">error</span>: action.payload.error,</span><br><span class="line">        <span class="attr">items</span>: [],</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="comment">// reducer 需要有 default case。</span></span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们需要把产品数据传给展示它们并且也负责请求数据的 <code>ProductList</code> 组件。</p>
<p>ProductList.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fetchProducts &#125; <span class="keyword">from</span> <span class="string">&#x27;/productActions&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.dispatch(fetchProducts());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; error, loading, products &#125; = <span class="built_in">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Error! &#123;error.message&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loading) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">        &#123;products.map((product) =&gt; (</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;product.id&#125;</span>&gt;</span>&#123;product.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">        ))&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">products</span>: state.products.items,</span><br><span class="line">  <span class="attr">loading</span>: state.products.loading,</span><br><span class="line">  <span class="attr">error</span>: state.products.error,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps)(ProductList);</span><br></pre></td></tr></table></figure>

<p>我指的是带有 <code>state.products.&lt;whatever&gt;</code> 的数据而不仅仅是 <code>state.&lt;whatever&gt;</code>，因为我假设你可能会有不止一个 reducer，每一个都处理各自的 state。为了确保这样，我们可以写一个 <code>rootReducer.js</code> 文件把它们放在一起：</p>
<p>rootReducer.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> products <span class="keyword">from</span> <span class="string">&#x27;./productReducer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;</span><br><span class="line">  products,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然后，当我们创建 store 我们可以传递这个“根” reducer：</p>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">&#x27;./rootReducer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(rootReducer);</span><br></pre></td></tr></table></figure>

<h2 id="Redux-中错误处理"><a href="#Redux-中错误处理" class="headerlink" title="Redux 中错误处理"></a>Redux 中错误处理</h2><p>这里的错误处理比较轻量，但是对大部分调用 API 的 actions 来说基本结构是一样的。基本观点是：</p>
<ol>
<li>当调用失败时，dispatch 一个 FAILURE action</li>
<li>通过设置一些标志变量和/或保存错误信息来处理 reducer 中的 FAILURE action。</li>
<li>把错误标志和信息（如果有的话）传给需要处理错误的组件，然后根据任何你觉得合适的方式渲染错误信息。</li>
</ol>
<h3 id="能避免重复渲染吗？"><a href="#能避免重复渲染吗？" class="headerlink" title="能避免重复渲染吗？"></a>能避免重复渲染吗？</h3><p>这确实个常见问题。是的，它<strong>会</strong>不止一次触发渲染。</p>
<p>它首先会渲染空 state，然后再渲染 loading state，接着会<strong>再次</strong>渲染展示产品。可怕！三次渲染！（如果你直接跳过 “loading” state 就可以把渲染次数将为两次）</p>
<p>你可能会担心不必要的渲染影响性能，但是不会：单次渲染非常快。如果你在开发的应用肉眼可见的慢的话，分析一下找出慢的原因。</p>
<p>这样想吧：当没有商品或者正在加载或者发生错误的时候应用需要展示<strong>一些东西</strong>。在数据准备好之前，你可能不想只展示一个空白屏幕。这给你了一个提供良好用户体验的机会。</p>
<h2 id="接下来呢？"><a href="#接下来呢？" class="headerlink" title="接下来呢？"></a>接下来呢？</h2><p>希望这篇教程能帮你更加理解 Redux！</p>
<p>如果你想深入了解里面的细节，<a target="_blank" rel="noopener" href="https://redux.js.org/">Redux 文档</a>有很多很好的例子。Mark Erikson (Redux 维护者之一)的博客有一个不错的<a target="_blank" rel="noopener" href="https://blog.isquaredsoftware.com/series/idiomatic-redux/">常用的 Redux 系列</a>。</p>
<p>下周，我会发布一个新课程，<a target="_blank" rel="noopener" href="https://daveceddia.com/pure-redux/">Pure Redux</a>，涵盖这里的所有内容，丰富了更多细节：</p>
<ul>
<li>如何做 immutable 更新</li>
<li>使用 Immer 轻松实现 immutable</li>
<li>使用 Redux DevTools 调试应用</li>
<li>为 reducers、actions 和 thunk actions 编写单元测试</li>
</ul>
<p>还有一整个模块讲解我们创建一个完整的应用，从开始到结束，包含这些：</p>
<ul>
<li>将 CRUD 操作与 Redux 集成 —— 增删查改</li>
<li>创建 API 服务</li>
<li>可访问路由以及路由加载时请求数据</li>
<li>处理模态对话框</li>
<li>将多个 reducer 与 combineReducers 结合使用</li>
<li>如何使用选择器以及 <code>reselect</code> 以提高性能和可维护性</li>
<li>权限和 session 管理</li>
<li>管理员和普通用户视图分离</li>
</ul>
<blockquote>
<p>如果发现译文存在错误或其他需要改进的地方，欢迎到 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a> 对译文进行修改并 PR，也可获得相应奖励积分。文章开头的 <strong>本文永久链接</strong> 即为本文在 GitHub 上的 MarkDown 链接。</p>
</blockquote>
<hr>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a> 是一个翻译优质互联网技术文章的社区，文章来源为 <a target="_blank" rel="noopener" href="https://juejin.im/">掘金</a> 上的英文分享文章。内容覆盖 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#android">Android</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#ios">iOS</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%89%8D%E7%AB%AF">前端</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%90%8E%E7%AB%AF">后端</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%8C%BA%E5%9D%97%E9%93%BE">区块链</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E4%BA%A7%E5%93%81">产品</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E8%AE%BE%E8%AE%A1">设计</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD">人工智能</a>等领域，想要查看更多优质译文请持续关注 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a>、<a target="_blank" rel="noopener" href="http://weibo.com/juejinfanyi">官方微博</a>、<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/juejinfanyi">知乎专栏</a>。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2017/12/17/2017/%E3%80%90%E8%AF%91%E3%80%91%E5%A6%82%E4%BD%95%E7%94%A8-TypeScript-%E7%8E%A9%E8%BD%AC%E5%90%8E%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2017/12/17/2017/%E3%80%90%E8%AF%91%E3%80%91%E5%A6%82%E4%BD%95%E7%94%A8-TypeScript-%E7%8E%A9%E8%BD%AC%E5%90%8E%E7%AB%AF/" class="post-title-link" itemprop="url">【译】如何用 TypeScript 玩转后端？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-12-17 22:49:24" itemprop="dateCreated datePublished" datetime="2017-12-17T22:49:24+00:00">2017-12-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 15:09:23" itemprop="dateModified" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%8E%98%E9%87%91%E7%BF%BB%E8%AF%91%E8%AE%A1%E5%88%92/" itemprop="url" rel="index"><span itemprop="name">掘金翻译计划</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<ul>
<li>原文地址：<a target="_blank" rel="noopener" href="https://medium.com/@igorandreev/how-to-start-with-backend-typescript-and-use-its-full-potential-5114e52012b">How to start with backend TypeScript and use it’s full potential.</a></li>
<li>原文作者：<a target="_blank" rel="noopener" href="https://medium.com/@igorandreev?source=post_header_lockup">idchlife</a></li>
<li>译文出自：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a></li>
<li>本文永久链接：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO/how-to-start-with-backend-typescript-and-use-its-full-potential.md">https://github.com/xitu/gold-miner/blob/master/TODO/how-to-start-with-backend-typescript-and-use-its-full-potential.md</a></li>
<li>译者：<a target="_blank" rel="noopener" href="https://github.com/xilihuasi">xilihuasi</a></li>
<li>校对者：<a target="_blank" rel="noopener" href="https://github.com/tvChan">tvChan</a>, <a target="_blank" rel="noopener" href="https://github.com/noahziheng">noahziheng</a></li>
</ul>
</blockquote>
<h1 id="如何用-TypeScript-玩转后端？"><a href="#如何用-TypeScript-玩转后端？" class="headerlink" title="如何用 TypeScript 玩转后端？"></a>如何用 TypeScript 玩转后端？</h1><p>我将从一个开发者的角度介绍几个优秀的库。它们可以满足你后端应用的绝大部分特性。装饰器和元数据的能力在这些库中得到的充分的应用，使其非常强大并且简单易用。</p>
<p>我希望这篇文章可以帮到像我这样，喜欢 TypeScript 而且想用它编写后端代码的人，让他们像我一样发现这些库之后乐在其中。</p>
<p><strong>TL;DR —— 堆栈使你的后端应用像许多使用其他语言的企业静态解决方案一样强大：</strong></p>
<ul>
<li><p>使用装饰器，参数，body 注入的路由和控制器的库</p>
</li>
<li><p>依赖注入和使用装饰器的 services 的库</p>
</li>
<li><p>使用装饰器的 ORM 就像 Doctrine/Hibernate 那样方便操作实体</p>
</li>
<li><p>给那些还不熟悉使用 TypeScript 写后端的朋友的小建议</p>
</li>
</ul>
<p><strong>Routing-controllers：控制器，行为，请求等</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/pleerock/routing-controllers"><strong>pleerock/routing-controllers</strong> routing-controllers —— 创建结构化，声明性和组织良好的基于类的控制器</a></p>
<p>尽管这个库是作为 Express/Koa 的 TypeScript helper 编写的，它也会对你编写控制器有所帮助，就像你在 Java/PHP/C# 的企业级框架里用到的那样。</p>
<p>下面是一个控制器的小例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import &#123;JsonController, Param, Body, Get, Post, Put, Delete&#125; from &quot;routing-controllers&quot;;</span><br><span class="line"></span><br><span class="line">@JsonController()</span><br><span class="line">export class UserController &#123;</span><br><span class="line"></span><br><span class="line">    @Get(&quot;/users&quot;)</span><br><span class="line">    getAll() &#123;</span><br><span class="line">       return userRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Get(&quot;/users/:id&quot;)</span><br><span class="line">    getOne(@Param(&quot;id&quot;) id: number) &#123;</span><br><span class="line">       return userRepository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Post(&quot;/users&quot;)</span><br><span class="line">    post(@Body() user: User) &#123;</span><br><span class="line">       return userRepository.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这对一些人来说就像是摆脱了噩梦：不再有带路由的组件，充满嵌套的中间件以及具有注入，验证和请求参数的中间件的实现（是的，你甚至可以定义参数类型和是否必传！如 @Body({ required: true, validate: true }) 这种写法将能很好地工作，如果缺少参数或者不正确的请求就会抛出异常）</p>
<p>装饰器有很多有用的特性，如基础控制器的 @Controller，可在 actions 中定义内容的类型以及使用 @JsonController 服务和接收 JSON。</p>
<p>我正在 Express 中使用它，既然我们有了 async/await （即使 TS Node.js 开发已经过了好几个月我还是忍不住赞美）我们似乎不再需要 Koa 了（现在 routing-controllers 可以更好的支持 Express ）。而且 Express 有更大的类型集 @types。</p>
<p>下面是我项目中使用 routing-controllers 和其他 @pleerock 库（VSCode, 如果有兴趣的话，引用来自 TypeLens 插件）的例子：</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*DdYJb1pIl3JYBfoCQPvSRw.png"></p>
<p>如你所见，routing-controllers 甚至提供了 undefined 返回码（也有 empty 和 null 的装饰器）以及许多其他特性。关于 this.playerService —— 这是另一个迷人的库，稍后我将介绍它。</p>
<p>总体来看，库有强大的文档，它可以帮助你理解和构建适用于操作甚至整个控制器的自定义中间件的应用程序（这对我来说是个绝妙的时刻）。链接地址如你所见就在那，非常方便。</p>
<p>当然，你也可以使用很多 Express/Koa 中间件把你的应用抽离出来，以及视图配置（库也有针对视图的装饰器），认证（可以通过中间件应用到整个控制层），错误处理等方面的配置。</p>
<p>通常我把他们存放在 /controllers 文件夹。</p>
<p><strong>TypeDI：依赖注入，services</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/pleerock/typedi">https://github.com/pleerock/typedi</a></p>
<p>这个库帮我定好了项目结构，方便编码并且不用去想「好吧 service 存在哪里，这个是 service？唔或许是另一个，但是，它怎么依赖另一个 service？怎么引用其他 service 唔。」</p>
<p>回到我的 PlayerService，下面这部分你可以看到它依赖了什么（其他 services）：</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*lpTGJEYWTCr18jjm8uAnbg.png"></p>
<p>@Inject 对我来说是在处理 services 和逻辑完整的后端应用方面最好用的装饰器。</p>
<p>（如果你想了解 @OrmEntityManager —— 另一个来自 @pleerock 的库，稍后我将讲解）</p>
<p>是的，你可以有很多 services 依赖其他的 services。并且如果你有 service 循环依赖，你可以通过明确地定义类型来解决这个问题（库的文档涵盖了大部分的问题和情景）</p>
<p>对那些不熟悉 services，service 容器，services 依赖注入等的朋友。简要说明：</p>
<p>你有某种功能，想把它存在类中，然后你想要类的实例并且想让这个类依赖另一个，另一个等。service 容器的依赖注入可以为你保驾护航。你可以从容器中获取 services 并且它会自己处理 services 的所有依赖，给你带有其他实例的工作实例自动注入。</p>
<p>我关于这个库的描述并不涵盖它的所有潜能（你可以自己查看它的文档——有更多的特性可以使用）：你可以在定义 services 时给它命名，还可以定义构造器注入等。</p>
<p>通常我把我的 services 存放在 /services 文件夹。</p>
<p><strong>TypeORM：使用 ORM 定义关系型实体，不同列类型和不同数据存储方案非常方便（关系型，非关系型）</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/typeorm/typeorm"><strong>typeorm/typeorm</strong>_typeorm —— 可在 TypeScript and JavaScript (ES7, ES6, ES5)环境中使用的 Data-Mapper ORM。支持 MySQL, PostgreSQL, MariaDB, SQLite</a></p>
<p>这给我的感觉就是，用 TypeScript 写 Node.js 最终有能力跟其他语言和 ORMS 竞争。</p>
<p>强大的 ORM 可以让你很方便地用一种可理解的方式编写实体。我不是其他许多类似这种 Node.js ORMS 的粉丝：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123; id: SomeORM.Integer, name: SomeOrm.String(&#123; …&#125;)&#125;</span><br></pre></td></tr></table></figure>

<p>我总是想让实体写成类。被赋予类型的属性的类，会被带有简单装饰器的 ORM 发现。甚至是没有类型的。</p>
<p>TypeORM 给你这种能力。我项目中的另一个例子：</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*VJEWGi8ycPxqaLNzjev7nA.png"></p>
<p>如你所见，我甚至没在装饰器中写属性的类型（你可以这样做，不要担心，明确地定义类型，默认的，可空的等）！TypeORM 为我做了所有这些工作，了解什么类型（感谢 TypeScript 反射：元数据扩展功能）以及把它应用在我的数据库。</p>
<p>它非常强大，你将拥有所有你在其他 ORMs 中拥有/看到的东西，比如（Doctrine, Hibernate）。</p>
<p>当使用 routing-controllers 和 TypeDI，它会为你注入实体管理器（就像你在我的 PlayerService 截图中看到的一样）提供非常有用的装饰器或者连接你的控制器和 services（这<strong>非常</strong>方便）。</p>
<p>这个 ORM 有一个涵盖了大量功能的官方文档，你可以看看并且从中了解所有你开始使用它需要了解的东西。</p>
<p>我通常把我的数据库配置放在 /config 文件夹，实体放在 /entities 文件夹。</p>
<ul>
<li><strong>为什么一篇文章涵盖了所有这些库？</strong></li>
</ul>
<p>这正是有趣的部分。</p>
<p>Routing-controllers 就像是你应用的地基。它给你轻松连接那两个库的可能（涵盖在库文档中）。当然，如果你不想的话可以不用。它可以和任何 ORM 一同使用。</p>
<p>但是，当你使用全部这三个库时，你会让框架对比其他解决方案时显得太过强大（至少对我来说是这样）。你有控制器，参数注入，body 注入，参数验证，依赖注入，有了这些你可以忘掉手动提供依赖和定义类型，装饰属性的实体，查询 builder。这全都是靠 TypeScript！所以，后端也将有编译时类型检查！</p>
<ul>
<li><strong>是的，感谢涵盖了那些功能的库。但是再说一次，如何在 node 中使用 TypeScript？</strong></li>
</ul>
<p>好吧，这再简单不过了。你可以像平时一样写 typescript，配置它编译到 ES2015（node 现在有很多特性，不用把它编译成 ES2015 之前的版本了），使用 CommonJS 标准来实现模块即可。</p>
<p>并且使用 pm2 或其他东西在编译后启动 index/server/app.js 。基本上生产代码已经就绪。不用 ts-node 或者其他什么了。</p>
<p><strong>如果你喜欢这些库，不要忘了表达你的喜爱</strong></p>
<p>如你所见，没有很多人知道 routing-controllers 和 TypeDI，这些是我 TypeScript Node.js 项目用到的最强大并且好用的库了。如果你喜欢它们，请花一秒钟 star 它们并且宣传一下。它们帮了我很多，所以我希望它们可以帮到你和其他同样的 TypeScript 使用者！</p>
<p>这些库也有 gitter 社区，你可以通过谷歌搜索“gitter 库名”很方便地找到它们。</p>
<p>感谢阅读并且快乐地使用 TypeScript。欢迎评论或提问吧~</p>
<hr>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a> 是一个翻译优质互联网技术文章的社区，文章来源为 <a target="_blank" rel="noopener" href="https://juejin.im/">掘金</a> 上的英文分享文章。内容覆盖 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#android">Android</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#ios">iOS</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%89%8D%E7%AB%AF">前端</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%90%8E%E7%AB%AF">后端</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E5%8C%BA%E5%9D%97%E9%93%BE">区块链</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E4%BA%A7%E5%93%81">产品</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E8%AE%BE%E8%AE%A1">设计</a>、<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner#%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD">人工智能</a>等领域，想要查看更多优质译文请持续关注 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a>、<a target="_blank" rel="noopener" href="http://weibo.com/juejinfanyi">官方微博</a>、<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/juejinfanyi">知乎专栏</a>。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2017/03/21/2017/%E3%80%90%E8%AF%91%E3%80%91%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8-WebAssembly-%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2017/03/21/2017/%E3%80%90%E8%AF%91%E3%80%91%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8-WebAssembly-%E7%BB%84%E4%BB%B6/" class="post-title-link" itemprop="url">【译】创建和使用 WebAssembly 组件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-03-21 14:03:31" itemprop="dateCreated datePublished" datetime="2017-03-21T14:03:31+00:00">2017-03-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 15:09:23" itemprop="dateModified" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%8E%98%E9%87%91%E7%BF%BB%E8%AF%91%E8%AE%A1%E5%88%92/" itemprop="url" rel="index"><span itemprop="name">掘金翻译计划</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<ul>
<li>原文地址：<a target="_blank" rel="noopener" href="https://hacks.mozilla.org/2017/02/creating-and-working-with-webassembly-modules/">Creating and working with WebAssembly modules</a></li>
<li>原文作者：本文已获作者 <a target="_blank" rel="noopener" href="https://code-cartoons.com/@linclark">Lin Clark</a> 授权</li>
<li>译文出自：<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner">掘金翻译计划</a></li>
<li>译者： <a target="_blank" rel="noopener" href="https://github.com/xilihuasi">xilihuasi</a></li>
<li>校对者：<a target="_blank" rel="noopener" href="https://github.com/Tina92">Tina92</a>、<a target="_blank" rel="noopener" href="https://github.com/zhouzihanntu">zhouzihanntu</a></li>
</ul>
</blockquote>
<h1 id="创建和使用-WebAssembly-组件"><a href="#创建和使用-WebAssembly-组件" class="headerlink" title="创建和使用 WebAssembly 组件"></a>创建和使用 WebAssembly 组件</h1><p><strong>这是 WebAssembly 系列文章的第四部分。如果你还没阅读过前面的文章，我们建议你<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO/a-cartoon-intro-to-webassembly.md">从头开始</a>。</strong></p>
<p>WebAssembly 是一种不同于 JavaScript 的在 web 页面上运行程序语言的方式。以前当你想在浏览器上运行代码来实现 web 页面不同部分的交互时，你唯一的选择就是 JavaScript。</p>
<p>因此当人们谈论 WebAssembly 运行迅速时，合理的比较对象就是 JavaScript。但这并不意味着你必须在 WebAssembly 和 JavaScript 二者中选择一个使用。</p>
<p>事实上我们希望开发者在同一应用中同时使用 WebAssembly 和 JavaScript。即使你不亲自写 WebAssembly 代码，你也可以使用它。</p>
<p>WebAssembly 组件定义的函数可以在 JavaScript 中使用。因此，就像现在你可以从 npm 上下载一个 lodash 这样的组件并且根据它的 API 调用方法一样，在未来你同样可以下载 WebAssembly 组件。</p>
<p>那么让我们看看如何创建 WebAssembly 组件，以及如何在 JavaScript 中使用这些组件吧。</p>
<h2 id="WebAssembly-处于哪个环节？"><a href="#WebAssembly-处于哪个环节？" class="headerlink" title="WebAssembly 处于哪个环节？"></a>WebAssembly 处于哪个环节？</h2><p>在上一篇关于<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO/a-crash-course-in-assembly.md">汇编</a>的文章里，我谈到过编译器怎么提取高级程序语言并且把它们翻译成机器码。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2017/02/04-01-langs09-500x306.png" alt="Diagram showing an intermediate representation between high level languages and assembly languages, with arrows going from high level programming languages to intermediate representation, and then from intermediate representation to assembly language"></p>
<p>WebAssembly 对应这张图片的哪个部分？</p>
<p>你可能认为它只不过是又一个目标汇编语言。某种程度上是对的，不同之处在于那些语言(x86,ARM)中每个都对应一个特定的机器架构。</p>
<p>当你通过 web 向用户的机器上发送要执行的代码时，你并不知道你的代码将要在哪种目标架构上运行。</p>
<p>所以 WebAssembly 和其他的汇编有些细微的差别。它是概念机的机器语言，而非真实的物理机。</p>
<p>正因如此，WebAssembly 指令有时也被称为虚拟指令。它们比 JavaScript 源码有更直接的机器码映射。它们代表一类可以在常见的流行硬件上高效执行的指令集合。但是它们并不直接映射某一具体硬件的特定机器码。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2017/02/04-02-langs08-500x326.png" alt="Same diagram as above with WebAssembly inserted between the intermediate representation and assembly"></p>
<p>浏览器下载 WebAssembly 后，它就能从 WebAssembly 转成目标机器的汇编码。</p>
<h2 id="编译成-wasm"><a href="#编译成-wasm" class="headerlink" title="编译成 .wasm"></a>编译成 .wasm</h2><p>LLVM 是当前对 WebAssembly 支持最好的编译工具链。很多前后端编译工具都可以嵌入 LLVM 中。</p>
<blockquote>
<p>注：大部分 WebAssembly 组件开发者用 C 和 Rust 这样的语言编写代码，然后编译成 WebAssembly，但仍有其他的方法来创建 WebAssembly 组件。比如，有一个实验性的工具帮你<a target="_blank" rel="noopener" href="https://github.com/rsms/wasm-util">使用 TypeScript 构建 WebAssembly 组件</a>，或者你可以<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format">直接在 WebAssembly 的文本表示上编码</a>。</p>
</blockquote>
<p>比如说我们想把 C 编译成 WebAssembly。我们可以使用 clang 编译器前端把 C 编译成 LLVM 中介码。一旦它处于 LLVM 的中间层，LLVM 编译它，LLVM 就可以展现一些性能优化。</p>
<p>要把 LLVM IR（<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Intermediate_representation">中介码</a>）编译成 WebAssembly，我们需要一个后端支持。在 LLVM 项目中有一个这类后端正在开发中。这个后端项目已经接近完成并且应该很快就会定稿。然而，现在使用它还会有不少问题。</p>
<p>目前有一个稍微容易使用的工具叫 Emscripten。他有自己的后端，可以通过编译成其他对象(称为 asm.js)然后再转换成 WebAssembly 的方式来产生 WebAssembly。好像它底层仍旧使用 LLVM，因此你可以在 Emscripten 中切换这两种后端。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2017/02/04-03-toolchain07-500x411.png" alt="Diagram of the compiler toolchain"></p>
<p>Emscripten 包含了许多附加工具和库来支持移植整个 C/C++ 代码库，因此它更像一个 SDK 而非编译器。举个例子，系统开发人员习惯于有一个文件系统用来读写，所以 Emscripten 可以使用 IndexedDB 模拟一个文件系统。</p>
<p>忽略你已经使用的工具链，最后得到的结果就是一个后缀名为 .wasm 的文件。下面我将着重解释 .wasm 文件的结构。首先，我们先看看怎样在 JS 中使用 .wasm 文件。</p>
<h2 id="在-JavaScript-中载入一个-wasm-组件"><a href="#在-JavaScript-中载入一个-wasm-组件" class="headerlink" title="在 JavaScript 中载入一个 .wasm 组件"></a>在 JavaScript 中载入一个 .wasm 组件</h2><p>这个 .wasm 文件是一个 WebAssembly 组件，它可以在 JavaScript 中载入。在此情景下，载入过程稍微有些复杂。</p>
<pre><code>functionfetchAndInstantiate(url, importObject) &#123;
  return fetch(url).then(response =&gt;
    response.arrayBuffer()
  ).then(bytes =&gt;
    WebAssembly.instantiate(bytes, importObject)
  ).then(results =&gt;
    results.instance
  );
&#125;
</code></pre>
<p>你可以在<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/WebAssembly">我们的文档</a>中深入了解这部分内容。</p>
<p>我们致力于让这个过程变得更容易。我们期望改进工具链，整合已存在的像 webpack 这样的模块打包工具以及类似 SystemJS 的动态加载器。我们相信载入 WebAssembly 组件可以像载入 JavaScript 组件一样简单。</p>
<p>不过，WebAssembly 组件和 JS 组件有一个显著的区别。目前，WebAssembly 函数只能使用数字（整型或浮点型数字）作为参数和返回值。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2017/02/04-04-memory04-500x93.png" alt="Diagram showing a JS function calling a C function and passing in an integer, which returns an integer in response"></p>
<p>对于更加复杂的数据类型，如字符串，你必须使用 WebAssembly 组件存储器。</p>
<p>像 C，C++，和 Rust 这些更高性能的语言倾向于手动管理内存。如果你大部分时间都在使用 JavaScript，也许对直接访问存储器的操作不熟悉。WebAssembly 组件存储器模拟了你在这些语言中会看到的堆。</p>
<p>为了实现这个功能，它使用了 JavaScript 中的类型化数组(ArrayBuffer)。类型化数组是存放字节的数组。数组的索引就是对应的存储器地址。</p>
<p>如果想要在 JavaScript 和 WebAssembly 中传递字符串，你需要把这些字符转换成他们的字符码常量。然后把这些写入存储器阵列。既然索引是整数，那么单个索引值就可以传入 WebAssembly 函数中。这样字符串中第一个字符的索引就可以被当成一个指针使用。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2017/02/04-05-memory12-500x400.png" alt="Diagram showing a JS function calling a C function with an integer that represents a pointer into memory, and then the C function writing into memory"></p>
<p>几乎所有想要开发供 web 开发者使用的 WebAssembly 组件的开发者，都会为组件创建一个包装器。这样以来，你作为组件的消费者并不需要了解内存管理。</p>
<p>如果想了解更多的话，查看我们关于<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/WebAssembly/Memory">使用 WebAssembly 内存</a>的文档。</p>
<h2 id="wasm-文件结构"><a href="#wasm-文件结构" class="headerlink" title=".wasm 文件结构"></a>.wasm 文件结构</h2><p>如果你使用高级语言来编写代码然后把它编译成 WebAssembly，你不必知道 WebAssembly 组件的结构。但是它可以帮助你理解其基本原理。</p>
<p>如果你之前没有了解这些基本原理，我们建议你先阅读 <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO/a-crash-course-in-assembly.md">汇编文章</a> (part 3 of the series)。</p>
<p>下面是一个 C 函数，我们将把它转成 WebAssembly：</p>
<pre><code>int add42(int num) &#123;
  return num + 42;
&#125;
</code></pre>
<p>你可以使用 <a target="_blank" rel="noopener" href="http://mbebenita.github.io/WasmExplorer/">WASM Explorer</a> 来编译这个函数。</p>
<p>如果你打开 .wasm 文件（假设你的编辑器支持显示），你将看到类似这样的内容：</p>
<pre><code>00 61 73 6D 0D 00 00 00 01 86 80 80 80 00 01 60
01 7F 01 7F 03 82 80 80 80 00 01 00 04 84 80 80
80 00 01 70 00 00 05 83 80 80 80 00 01 00 01 06
81 80 80 80 00 00 07 96 80 80 80 00 02 06 6D 65
6D 6F 72 79 02 00 09 5F 5A 35 61 64 64 34 32 69
00 00 0A 8D 80 80 80 00 01 87 80 80 80 00 00 20
00 41 2A 6A 0B
</code></pre>
<p>这是组件的“二进制”表示法。我把二进制加上引号是因为它通常显示的是十六进制符号，但这很容易转换成二进制符号，或者人类可读的格式。</p>
<p>举个例子，下图是 <code>num + 42</code> 的几种表现形式。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2017/02/04-06-hex_binary_asm01-500x254.png" alt="Table showing hexadecimal representation of 3 instructions (20 00 41 2A 6A), their binary representation, and then the text representation (get_local 0, i32.const 42, i32.add)"></p>
<h3 id="代码如何运行：堆栈机"><a href="#代码如何运行：堆栈机" class="headerlink" title="代码如何运行：堆栈机"></a>代码如何运行：堆栈机</h3><p>如果你想知道的话，下图是执行的一些指令说明。</p>
<p><img src="https://2r4s9p1yi1fa2jd7j43zph8r-wpengine.netdna-ssl.com/files/2017/02/04-07-hex_binary_asm02-500x175.png" alt="Diagram showing that get_local 0 gets value of first param and pushes it on the stack, i32.const 42 pushes a constant value on the stack, and i32.add adds the top two values from the stack and pushes the result"></p>
<p>你可能注意到了 <code>add</code> 操作并没有说明他的值应该从哪里来。这是因为 WebAssembly 是堆栈机的一个范例。这意味着一个操作所需的所有值在操作执行之前都在栈中排队。</p>
<p>例如 <code>add</code> 这类的操作指导它们需要多少值。如果 <code>add</code> 需要两个值，它将从栈顶取出两个值。这意味着 <code>add</code> 指令可以很短（单个字节），因为指令不需要指定源或者目的寄存器。这减少了 .wasm 文件的大小，也意味着下载的耗时更短。</p>
<p>即使 WebAssembly 就堆栈机而言是特定的，但那不是其在物理机上的工作方式。当浏览器把 WebAssembly 转化成其运行机器上对应的机器码时，将会用到寄存器。因为 WebAssembly 代码不指定寄存器，所以浏览器在当前机器上能更灵活的去使用最佳寄存器分配。</p>
<h3 id="组件的-sections"><a href="#组件的-sections" class="headerlink" title="组件的 sections"></a>组件的 sections</h3><p>除了 <code>add42</code> 函数自身，.wasm 文件还有其他部分。那就是 sections。一些 sections 对任何组件都是必需的，而有一些是可选的。</p>
<p>必选项：</p>
<ol>
<li>**类型(Type)**。包括在该组件中定义的函数签名以及任何引入的函数。</li>
<li>**函数(Function)**。给每一个在该组件中定义的函数一个索引。</li>
<li>**代码(Code)**。该组件中定义的每一个函数的实际函数体。</li>
</ol>
<p>可选项：</p>
<ol>
<li>**导出(Export)**。使函数，内存，表以及全局变量对其他 WebAssembly 组件和 JavaScript 可用。这使独立编译的组件可以被动态链接在一起。这就是 WebAssembly 的 .dll 版本。</li>
<li>**导入(Import)**。从其他 WebAssembly 组件或 JavaScript 中导入指定的函数，内存，表以及全局变量。</li>
<li>**启动(Start)**。当 WebAssembly 组件载入时自动运行的函数(基本上类似一个主函数)。</li>
<li>**全局变量(Global)**。为组件声明全局变量。</li>
<li><strong>内存（Memory）</strong>。定义组件将使用到的内存空间。</li>
<li><strong>表（Table）</strong>。使把值映射到 WebAssembly 组件外部成为可能，比如 JavaScript 对象。这对于允许间接函数调用相当有用。</li>
<li><strong>数据（Data）</strong>。初始化导入或本地内存。</li>
<li><strong>元素（Element）</strong>。初始化导入或本地的表。</li>
</ol>
<p>更多关于 sections 的阐释，这有一篇深度好文<a target="_blank" rel="noopener" href="https://rsms.me/wasm-intro">解释这些 sections 如何运行</a>。</p>
<h2 id="接下来"><a href="#接下来" class="headerlink" title="接下来"></a>接下来</h2><p>现在你知道怎样使用 WebAssembly 组件了，让我们看看<a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO/what-makes-webassembly-fast.md">为什么 WebAssembly 这么快</a>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2017/02/28/2017/Sass%E7%94%A8%E6%B3%95%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2017/02/28/2017/Sass%E7%94%A8%E6%B3%95%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">Sass用法介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-02-28 23:20:10" itemprop="dateCreated datePublished" datetime="2017-02-28T23:20:10+00:00">2017-02-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 15:09:23" itemprop="dateModified" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/css/" itemprop="url" rel="index"><span itemprop="name">css</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>CSS 决定前端的颜值，但其落后的语法一直被诟病。CSS 本身是简单并有趣的，但当样式表变得庞大、复杂后，CSS 变得难以维护。直到 Sass,Less,Stylus 等预处理工具的出现，才使这一问题得到缓解。
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2017/02/28/2017/Sass%E7%94%A8%E6%B3%95%E4%BB%8B%E7%BB%8D/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2016/11/25/hexo%E9%83%A8%E7%BD%B2%E5%88%B0github/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2016/11/25/hexo%E9%83%A8%E7%BD%B2%E5%88%B0github/" class="post-title-link" itemprop="url">hexo部署到github</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-11-25 10:56:34" itemprop="dateCreated datePublished" datetime="2016-11-25T10:56:34+00:00">2016-11-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 15:09:23" itemprop="dateModified" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/hexo/" itemprop="url" rel="index"><span itemprop="name">hexo</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>之前介绍了如何搭建本地 hexo 环境，相信很多小朋友已经搭建成功了。但是写了博客只放在本地不跟大家分享肯定不是我们想要的，本文就手把手教你怎样把 hexo 部署到 github Page 上跟大家分享你的文章。
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2016/11/25/hexo%E9%83%A8%E7%BD%B2%E5%88%B0github/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xilihuasi.github.io/blog/2016/10/24/How-to-build-Hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="xilihuasi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xilihuasi's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2016/10/24/How-to-build-Hexo/" class="post-title-link" itemprop="url">How to build Hexo</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-10-24 14:38:10" itemprop="dateCreated datePublished" datetime="2016-10-24T14:38:10+00:00">2016-10-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-06-01 15:09:23" itemprop="dateModified" datetime="2021-06-01T15:09:23+00:00">2021-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/hexo/" itemprop="url" rel="index"><span itemprop="name">hexo</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本教程默认你已经搭建好了 Node 和 Git 环境</p>
<h2 id="step-1"><a href="#step-1" class="headerlink" title="step 1"></a>step 1</h2><p>在控制台执行如下命令安装 hexo：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2016/10/24/How-to-build-Hexo/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




<script src="/blog/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xilihuasi</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  






  





</body>
</html>
